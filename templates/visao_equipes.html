{% extends "base.html" %}
{% block content %}
  <h2 style="text-align: center;">Visão por Equipe: {{ equipe_selecionada }}</h2>

  <!-- Voltar -->
  <a href="{{ url_for('index') }}">
    <button type="button">Voltar para Página Inicial</button>
  </a>
  <br><br>

  <!-- Filtro de equipe (preserva 'target' se veio da nova_montagem) -->
  <form method="get" style="text-align: center; margin-bottom: 20px;">
    <input type="hidden" name="target" value="{{ target or '' }}">
    <select name="equipe" onchange="this.form.submit()">
      <option value="">Selecione uma equipe</option>
      <option value="Dirigentes" {% if equipe_selecionada == 'Dirigentes' %}selected{% endif %}>Dirigentes</option>
      <option value="Sala" {% if equipe_selecionada == 'Sala' %}selected{% endif %}>Sala</option>
      <option value="Circulos" {% if equipe_selecionada == 'Circulos' %}selected{% endif %}>Círculos</option>
      <option value="Café e Minimercado" {% if equipe_selecionada == 'Café e Minimercado' %}selected{% endif %}>Café e Minimercado</option>
      <option value="Compras" {% if equipe_selecionada == 'Compras' %}selected{% endif %}>Compras</option>
      <option value="Acolhida" {% if equipe_selecionada == 'Acolhida' %}selected{% endif %}>Acolhida</option>
      <option value="Ordem e Limpeza" {% if equipe_selecionada == 'Ordem e Limpeza' %}selected{% endif %}>Ordem e Limpeza</option>
      <option value="Secretaria" {% if equipe_selecionada == 'Secretaria' %}selected{% endif %}>Secretaria</option>
      <option value="Liturgia e Vigilia" {% if equipe_selecionada == 'Liturgia e Vigilia' %}selected{% endif %}>Liturgia e Vigilia</option>
      <option value="Cozinha" {% if equipe_selecionada == 'Cozinha' %}selected{% endif %}>Cozinha</option>
      <option value="Visitação" {% if equipe_selecionada == 'Visitação' %}selected{% endif %}>Visitação</option>
    </select>
  </form>

  {% if tabela %}
  <table border="1" style="margin: auto; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Ano</th>
        {% for col in colunas %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for ano, linha in tabela.items() %}
        <tr>
          <td>{{ ano }}</td>
          {% for nome in linha %}
            {% set raw = nome or '' %}
            {% set is_coord = raw.startswith('*') %}   {# Coordenador do ano/linha #}
            {% set is_mark  = raw.startswith('~') %}   {# Marcado amarelo (já foi coordenador globalmente) #}
            {% set clean    = raw[1:] if (is_coord or is_mark) else raw %}
            <td>
              {% if raw %}
                {% if is_coord %}
                  <b>{{ clean }}</b>
                {% else %}
                  {# Se veio da nova_montagem (tem target), habilita links;
                     se veio do index (sem target), mostra apenas o texto. #}
                  {% if target %}
                    {% set partes = clean.split(' e ') %}
                    {% if partes|length == 2 %}
                      {% if is_mark %}
                        <span style="background-color: yellow">
                          <a href="{{ url_for('nova_montagem') }}?ano={{ ano }}&target={{ target|urlencode }}&ele={{ partes[0]|urlencode }}&ela={{ partes[1]|urlencode }}">{{ clean }}</a>
                        </span>
                      {% else %}
                        <a href="{{ url_for('nova_montagem') }}?ano={{ ano }}&target={{ target|urlencode }}&ele={{ partes[0]|urlencode }}&ela={{ partes[1]|urlencode }}">{{ clean }}</a>
                      {% endif %}
                    {% else %}
                      {% if is_mark %}
                        <span style="background-color: yellow">{{ clean }}</span>
                      {% else %}
                        {{ clean }}
                      {% endif %}
                    {% endif %}
                  {% else %}
                    {% if is_mark %}
                      <span style="background-color: yellow">{{ clean }}</span>
                    {% else %}
                      {{ clean }}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
{% endblock %}
