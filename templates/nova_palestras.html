<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Cadastro de Palestras por Ano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#f6f7fb; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; --brand:#2563eb; --brand-600:#1e40af; --brand-50:#eff6ff; --accent:#f59e0b;}
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      background:
        radial-gradient(1200px 800px at 80% -10%, #e0ebff 0%, rgba(224,235,255,0) 60%),
        radial-gradient(1000px 600px at -10% 110%, #fff3d6 0%, rgba(255,243,214,0) 60%),
        var(--bg);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 64px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; padding:8px 0 12px;}
    h1{margin:0; font-size:22px;}
    .btn{appearance:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:12px; text-decoration:none; color:inherit; cursor:pointer;}
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand);}
    .muted{color:var(--muted)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 8px 20px rgba(15,23,42,.05);}
    .grid{display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));}
    label{display:block; font-size:12px; font-weight:600; color:#334155; margin-bottom:6px;}
    input{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;}
    .inline{display:inline-flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .status{margin-top:6px; font-size:13px;}
    .ok{color:#065f46} .warn{color:#92400e} .err{color:#991b1b}
    /* medidor de repetições (0..5) */
    .meter{height:8px; border-radius:999px; background:linear-gradient(90deg,#16a34a 0%, #f59e0b 50%, #dc2626 100%); position:relative; overflow:hidden;}
    .meter .fill{height:100%; background:rgba(255,255,255,.6); width:0%;}
    .info{font-size:12px; color:#334155}
    .row{display:grid; gap:10px; grid-template-columns: 1fr 1fr;}
    .readonly{background:#f8fafc}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0b1220; --card:#0f172a; --border:#1e293b; --ink:#e2e8f0; --muted:#94a3b8; --brand:#3b82f6; --brand-600:#1d4ed8; --brand-50:#0b255a; --accent:#fde68a;}
      .card{box-shadow:none}
      .readonly{background:#0b1220}
      .meter .fill{background:rgba(0,0,0,.35)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Cadastro de Palestras por Ano</h1>
      <div class="inline">
        <a class="btn" href="{{ url_for('palestras_painel') }}">← Palestras</a>
        <a class="btn" href="{{ url_for('index') }}">⌂ Página Inicial</a>
      </div>
    </header>

    <p class="muted">Selecione o <b>ano</b> e preencha os palestrantes. Para títulos de casal, é feito controle de <b>repetições (máx. 5)</b>, elegibilidade e exibição de <b>telefones/endereço</b>.</p>

    <div class="card">
      <label for="ano">Ano</label>
      <div class="inline">
        <input id="ano" type="number" inputmode="numeric" placeholder="Ex.: 2025" value="{{ ano_preselecionado or '' }}" style="max-width:180px;">
        <button class="btn primary" id="btn-aplicar">Aplicar</button>
      </div>
      <div class="status" id="ano-status"></div>
    </div>

    <p class="muted" id="kpi" style="display:none; margin:8px 0;">Preenchidos: <b id="kpi-done">0</b>/<b id="kpi-total">{{ titulos|length }}</b></p>

    <div class="grid" id="grid" style="display:none;"></div>
  </div>

  <script>
    const TITULOS = {{ titulos | tojson }};
    const NON_COUPLE = new Set({{ non_couple_titles | tojson }});
    const INITIAL = {{ (initial or {}) | tojson }};
    const ANO_PRE = {{ ano_preselecionado | tojson }};

    const anoInput = document.getElementById('ano');
    const btnAplicar = document.getElementById('btn-aplicar');
    const anoStatus = document.getElementById('ano-status');
    const grid = document.getElementById('grid');
    const kpi = document.getElementById('kpi');
    const kpiDone = document.getElementById('kpi-done');

    let anoSel = null;

    function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_'); }

    function renderCard(titulo, preset){
      const id = slug(titulo);
      const isCouple = !NON_COUPLE.has(titulo);
      const card = document.createElement('div');
      card.className = 'card';

      let namesBlock = '';
      let toolsBlock = '';
      let extraBlock = '';

      if (isCouple){
        namesBlock = `
          <div class="row" style="margin-bottom:8px;">
            <div>
              <label for="${id}_ele">Nome (Ele)</label>
              <input id="${id}_ele" placeholder="Ex.: João" value="${preset?.nome_ele||''}">
            </div>
            <div>
              <label for="${id}_ela">Nome (Ela)</label>
              <input id="${id}_ela" placeholder="Ex.: Maria" value="${preset?.nome_ela||''}">
            </div>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <div>
              <label for="${id}_tels">Telefones</label>
              <input id="${id}_tels" class="readonly" placeholder="(preenchido no Buscar)" disabled>
            </div>
            <div>
              <label for="${id}_end">Endereço</label>
              <input id="${id}_end" class="readonly" placeholder="(preenchido no Buscar)" disabled>
            </div>
          </div>
          <div class="info">Repetições deste casal neste título (0 a 5):</div>
          <div class="meter" style="margin:6px 0 2px;">
            <div class="fill" id="${id}_meter" style="width:0%"></div>
          </div>
          <div class="info" id="${id}_repinfo">0 / 5</div>
        `;
        toolsBlock = `
          <div class="inline" style="margin-top:8px;">
            <button class="btn" id="${id}_buscar">Buscar</button>
            <button class="btn primary" id="${id}_salvar">Salvar</button>
          </div>
        `;
      } else {
        namesBlock = `
          <div>
            <label for="${id}_one">Nome (Palestrante)</label>
            <input id="${id}_one" placeholder="Ex.: Pe. João" value="${preset?.nome_ele||''}">
          </div>
        `;
        toolsBlock = `
          <div class="inline" style="margin-top:8px;">
            <button class="btn primary" id="${id}_salvar">Salvar</button>
          </div>
        `;
      }

      card.innerHTML = `
        <div class="inline" style="justify-content:space-between; width:100%; margin-bottom:6px;">
          <h3 style="margin:0;">${titulo}</h3>
          <div class="inline">
            <a class="btn" href="{{ url_for('palestra_topico') }}?ano=${encodeURIComponent(anoSel)}&titulo=${encodeURIComponent(titulo)}">Abrir</a>
          </div>
        </div>
        ${namesBlock}
        ${toolsBlock}
        <div class="status" id="${id}_status"></div>
        ${extraBlock}
      `;
      grid.appendChild(card);

      const $status = document.getElementById(`${id}_status`);

      if (isCouple){
        const $ele = document.getElementById(`${id}_ele`);
        const $ela = document.getElementById(`${id}_ela`);
        const $tels = document.getElementById(`${id}_tels`);
        const $end = document.getElementById(`${id}_end`);
        const $meter = document.getElementById(`${id}_meter`);
        const $repinfo = document.getElementById(`${id}_repinfo`);
        const $buscar = document.getElementById(`${id}_buscar`);
        const $salvar = document.getElementById(`${id}_salvar`);

        function paintMeter(rep){
          const pct = Math.min(100, Math.max(0, (rep/5)*100));
          $meter.style.width = pct + '%';
          $repinfo.textContent = `${rep} / 5`;
        }

        async function validate(){
          $status.textContent = '';
          const nome_ele = ($ele.value||'').trim();
          const nome_ela = ($ela.value||'').trim();
          if(!anoSel){ $status.textContent='Selecione o ano.'; $status.className='status warn'; return; }
          if(!nome_ele || !nome_ela){ $status.textContent='Informe Nome (Ele) e (Ela).'; $status.className='status warn'; return; }
          try{
            const r = await fetch('{{ url_for("api_palestras_validate") }}', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ano: anoSel, titulo: titulo, nome_ele, nome_ela })
            });
            const d = await r.json();
            if(!d.ok){ $status.textContent = d.msg || 'Falha na validação.'; $status.className='status err'; return; }
            paintMeter(d.repeticoes||0);
            $tels.value = d.telefones||''; $end.value = d.endereco||'';
            if (!d.eligible){ $status.textContent = 'Casal não elegível (precisa ser encontrista ou já ter trabalhado).'; $status.className='status err'; return; }
            if ((d.repeticoes||0) >= (d.cap||5)){ $status.textContent = 'Limite de repetições atingido para este casal.'; $status.className='status err'; return; }
            $status.textContent = 'Dados carregados e elegíveis.'; $status.className='status ok';
          }catch{ $status.textContent='Erro na validação.'; $status.className='status err'; }
        }

        async function salvar(){
          $status.textContent = '';
          const nome_ele = ($ele.value||'').trim();
          const nome_ela = ($ela.value||'').trim();
          if(!anoSel){ $status.textContent='Selecione o ano.'; $status.className='status warn'; return; }
          try{
            const r = await fetch('{{ url_for("api_palestras_save") }}', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ano: anoSel, titulo: titulo, nome_ele, nome_ela })
            });
            const d = await r.json();
            if(d.ok){ $status.textContent = (d.action==='insert'?'Registrado.':'Atualizado.'); $status.className='status ok'; updateKPI(); }
            else { $status.textContent = d.msg||'Falha ao salvar.'; $status.className='status err'; }
          }catch{ $status.textContent='Erro ao salvar.'; $status.className='status err'; }
        }

        $buscar.addEventListener('click', (e)=>{ e.preventDefault(); validate(); });
        $salvar.addEventListener('click', (e)=>{ e.preventDefault(); salvar(); });

        // pinta o meter se já houver valor
        if (preset && (preset.nome_ele || preset.nome_ela)) paintMeter(1);
      } else {
        const $one = document.getElementById(`${id}_one`);
        const $salvar = document.getElementById(`${id}_salvar`);
        async function salvarOne(){
          $status.textContent = '';
          const nome_ele = ($one.value||'').trim(); // vai em nome_ele
          if(!anoSel){ $status.textContent='Selecione o ano.'; $status.className='status warn'; return; }
          if(!nome_ele){ $status.textContent='Informe o nome do palestrante.'; $status.className='status warn'; return; }
          try{
            const r = await fetch('{{ url_for("api_palestras_save") }}', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ano: anoSel, titulo: titulo, nome_ele, nome_ela: '' })
            });
            const d = await r.json();
            if(d.ok){ $status.textContent = (d.action==='insert'?'Registrado.':'Atualizado.'); $status.className='status ok'; updateKPI(); }
            else { $status.textContent = d.msg||'Falha ao salvar.'; $status.className='status err'; }
          }catch{ $status.textContent='Erro ao salvar.'; $status.className='status err'; }
        }
        $salvar.addEventListener('click', (e)=>{ e.preventDefault(); salvarOne(); });
      }
    }

    function updateKPI(){
      let done = 0;
      for(const t of TITULOS){
        const id = slug(t);
        if (NON_COUPLE.has(t)){
          const one = document.getElementById(`${id}_one`);
          if ((one && one.value.trim()) || (INITIAL[t] && INITIAL[t].nome_ele)) done++;
        } else {
          const ele = document.getElementById(`${id}_ele`);
          const ela = document.getElementById(`${id}_ela`);
          const has = (ele && ele.value.trim()) || (ela && ela.value.trim()) || (INITIAL[t] && (INITIAL[t].nome_ele || INITIAL[t].nome_ela));
          if (has) done++;
        }
      }
      kpiDone.textContent = String(done);
    }

    btnAplicar.addEventListener('click', (e)=>{
      e.preventDefault();
      const val = (anoInput.value||'').trim();
      if(!/^\d{4}$/.test(val)){ anoStatus.textContent='Ano inválido (YYYY).'; anoStatus.className='status err'; return; }
      anoSel = parseInt(val,10);
      anoStatus.textContent = `Ano selecionado: ${anoSel}`; anoStatus.className='status ok';
      grid.innerHTML = '';
      for(const t of TITULOS){
        renderCard(t, INITIAL[t]);
      }
      grid.style.display = '';
      kpi.style.display = '';
      updateKPI();
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      if(ANO_PRE){ btnAplicar.click(); }
    });
  </script>
</body>
</html>
