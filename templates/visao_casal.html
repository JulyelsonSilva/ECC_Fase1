{% extends "_print_base.html" %}
{% block content %}
{% set title = "Visão do Casal" %}

{# ---------- Helpers ---------- #}
{% macro proper_case(s) -%}
  {% if not s %}{{ "" }}{% else %}
    {% set small = ['de','da','das','do','dos','e','d','di'] %}
    {% set parts = (s|string)|lower|trim|split(' ') %}
    {% set out = [] %}
    {% for p in parts %}
      {% set subtoks = p.split('-') %}
      {% set subtoks_out = [] %}
      {% for t in subtoks %}
        {% if loop.parentloop.first and loop.first %}
          {% set subtoks_out = subtoks_out + [t[:1]|upper ~ t[1:]] %}
        {% else %}
          {% if t in small %}
            {% set subtoks_out = subtoks_out + [t] %}
          {% else %}
            {% set subtoks_out = subtoks_out + [t[:1]|upper ~ t[1:]] %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% set token = '-'.join(subtoks_out) %}
      {% set out = out + [token] %}
    {% endfor %}
    {{ out|join(' ') }}
  {% endif %}
{%- endmacro %}

{% macro fmt_nome(ele, ela) -%}
  {{ proper_case(ele or '') }} &amp; {{ proper_case(ela or '') }}
{%- endmacro %}

{% macro status_badge(st) -%}
  {% set v = (st or '')|trim|lower %}
  {% if v == 'recusou' %}
    <span class="badge" style="background:#fee2e2; border-color:#fecaca; color:#991b1b;">Recusou</span>
  {% elif v == 'desistiu' %}
    <span class="badge" style="background:#fffbeb; border-color:#fef3c7; color:#92400e;">Desistiu</span>
  {% elif v == 'concluido' %}
    <span class="badge" style="background:#ecfdf5; border-color:#d1fae5; color:#065f46;">Concluído</span>
  {% elif v == 'aberto' %}
    <span class="badge" style="background:#eff6ff; border-color:#dbeafe; color:#1e40af;">Aberto</span>
  {% elif v == 'aceito' %}
    <span class="badge" style="background:#eef2ff; border-color:#e0e7ff; color:#3730a3;">Aceito</span>
  {% endif %}
{%- endmacro %}

<h2>Visão do Casal</h2>

{% if erro %}
  <p class="muted">{{ erro }}</p>
{% else %}
  <div class="card" style="margin-bottom:10pt;">
    <h3 style="margin:0 0 6pt;">{{ fmt_nome(nome_ele, nome_ela) }}</h3>
    {% if dados_encontrista %}
      <p class="muted" style="margin:0;">
        Encontristas em {{ dados_encontrista.ano_encontro }} —
        {{ dados_encontrista.telefones or '—' }} • {{ dados_encontrista.endereco or '—' }}
      </p>
    {% endif %}
  </div>

  {% if anos and anos|length %}
    {% for a in anos %}
      <h3 style="margin:12pt 0 6pt;">{{ a }}</h3>
      <table>
        <thead>
          <tr>
            <th style="width:34%;">Equipe</th>
            <th style="width:18%;">Papel</th>
            <th style="width:18%;">Status</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody>
          {# Trabalhos (encontreiros) #}
          {% for r in (por_ano_trabalhos.get(a) or []) %}
            {% set coord = (r.coordenador or '')|trim|lower == 'sim' %}
            {% set st = r.status or '' %}
            <tr>
              <td>{{ r.equipe or '—' }}</td>
              <td>
                {% if coord %}
                  <span class="badge">Coordenador</span>
                {% else %}
                  Integrante
                {% endif %}
              </td>
              <td>{{ status_badge(st) }}</td>
              <td>
                {# Em caso de Recusou/Desistiu, exiba o motivo; senão, mostre observações se houver #}
                {% set v = (st or '')|trim|lower %}
                {% if v in ['recusou','desistiu'] %}
                  {{ r.observacao or '—' }}
                {% else %}
                  {{ r.observacao or '' }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}

          {# Palestras (se houver no ano) #}
          {% for p in (por_ano_palestras.get(a) or []) %}
            <tr>
              <td>—</td>
              <td>Palestra</td>
              <td>—</td>
              <td>{{ p.palestra }}</td>
            </tr>
          {% endfor %}

          {% if not (por_ano_trabalhos.get(a) or []) and not (por_ano_palestras.get(a) or []) %}
            <tr><td colspan="4" class="muted">Sem registros neste ano.</td></tr>
          {% endif %}
        </tbody>
      </table>
    {% endfor %}
  {% else %}
    <p class="muted">Sem histórico para este casal.</p>
  {% endif %}
{% endif %}
{% endblock %}
