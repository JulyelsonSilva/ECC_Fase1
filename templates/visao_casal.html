{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --bg:#f6f7fb; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb;
    --brand:#2563eb; --brand-600:#1e40af; --brand-50:#eff6ff; --accent:#f59e0b;
    --ok:#065f46; --warn:#92400e; --err:#b91c1c;
  }
  .vc-wrap{max-width:1100px;margin:24px auto;padding:0 16px 40px;color:var(--ink)}
  .vc-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  .vc-title{display:flex;align-items:center;gap:10px}
  .vc-logo{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--brand-600));color:#fff;font-size:22px}
  h1{margin:0;font-size:22px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;color:inherit}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .search{display:grid;gap:10px;grid-template-columns: 1fr 1fr auto}
  .search input{padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;margin-left:6px}
  .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top;text-align:left}
  .table thead th{background:#f1f5f9;font-weight:600}
  .table tr:last-child td{border-bottom:none}
</style>

<div class="vc-wrap">
  <div class="vc-head">
    <div class="vc-title">
      <div class="vc-logo" aria-hidden="true">ðŸ’‘</div>
      <div>
        <h1>VisÃ£o do Casal</h1>
        <div class="muted" style="font-size:13px">ParÃ³quia Divino EspÃ­rito Santo â€” JatiÃºca</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="{{ url_for('index') }}">âŒ‚ PÃ¡gina Inicial</a>
    </div>
  </div>

  {# ===== Busca (APENAS UMA) ===== #}
  <div class="card" style="margin-bottom:12px">
    <form method="get" class="search" autocomplete="off">
      <input type="text" id="nome_ele" name="nome_ele" placeholder="Nome (Ele)" value="{{ nome_ele }}" list="sugestoes_ele" required>
      <datalist id="sugestoes_ele"></datalist>
      <input type="text" id="nome_ela" name="nome_ela" placeholder="Nome (Ela)" value="{{ nome_ela }}" list="sugestoes_ela" required>
      <datalist id="sugestoes_ela"></datalist>
      <button type="submit" class="btn primary">Buscar</button>
    </form>
    {% if erro %}<div class="muted" style="color:var(--err);margin-top:8px">{{ erro }}</div>{% endif %}
  </div>

  {# ===== Dados do Encontro (encontristas) ===== #}
  {% if dados_encontrista %}
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px">Dados do Encontro</h3>
      <div><b>Ano do Encontro:</b> {{ dados_encontrista.ano_encontro }}</div>
      <div><b>EndereÃ§o:</b> {{ dados_encontrista.endereco or 'â€”' }}</div>
      <div><b>Telefones:</b> {{ dados_encontrista.telefones or 'â€”' }}</div>
    </div>
  {% elif nome_ele and nome_ela and not erro %}
    <div class="card" style="margin-bottom:12px">
      <div class="muted">Casal nÃ£o encontrado.</div>
    </div>
  {% endif %}

  {# ===== HistÃ³rico por Ano (ÃšNICO BLOCO) ===== #}
  <div class="card">
    <h3 style="margin:0 0 12px">HistÃ³rico por Ano</h3>
    <p class="muted" style="margin:0 0 10px">Equipes trabalhadas e palestras realizadas por ano.</p>

    <table class="table">
      <thead>
        <tr>
          <th style="width:80px;">Ano</th>
          <th>Equipes</th>
          <th>Palestras</th>
        </tr>
      </thead>
      <tbody>
        {# ===== Modo 1: usa anos + dicionÃ¡rios (preferido) ===== #}
        {% if anos is defined and por_ano_trabalhos is defined and por_ano_palestras is defined %}
          {% for ano in anos %}
            {% set trabs = por_ano_trabalhos.get(ano, []) %}
            {% set talks = por_ano_palestras.get(ano, []) %}
            <tr>
              <td>{{ ano }}</td>
              <td>
                {% if trabs %}
                  <ul style="margin:0;padding-left:16px">
                    {% for t in trabs %}
                      {% set st = (t.status or '')|trim|lower %}
                      <li>
                        {{ t.equipe or 'â€”' }}
                        {% if (t.coordenador or '')|trim|lower == 'sim' %}
                          <span class="pill">Coord.</span>
                        {% endif %}
                        {# Exibe STATUS e MOTIVO somente para Recusou/Desistiu #}
                        {% if st in ['recusou','desistiu'] %}
                          <span class="pill" style="border-color:#fecaca;background:#fee2e2;color:#991b1b;margin-left:6px">{{ st|capitalize }}</span>
                          {% if t.observacao %}<span class="pill" style="margin-left:6px">{{ t.observacao }}</span>{% endif %}
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% else %} â€” {% endif %}
              </td>
              <td>
                {% if talks %}
                  <ul style="margin:0;padding-left:16px">
                    {% for p in talks %}
                      <li>{{ p.palestra or '' }}</li>
                    {% endfor %}
                  </ul>
                {% else %} â€” {% endif %}
              </td>
            </tr>
          {% endfor %}
        {# ===== Modo 2: compatibilidade com listas cruas ===== #}
        {% else %}
          {# Agrupa trabalhos por ano #}
          {% set trab_por_ano = {} %}
          {% for r in (dados_encontreiros or []) %}
            {% set lst = trab_por_ano.get(r.ano, []) + [r] %}
            {% if trab_por_ano.update({r.ano: lst}) %}{% endif %}
          {% endfor %}
          {# Agrupa palestras por ano #}
          {% set pal_por_ano = {} %}
          {% for p in (dados_palestras or []) %}
            {% set lst = pal_por_ano.get(p.ano, []) + [p] %}
            {% if pal_por_ano.update({p.ano: lst}) %}{% endif %}
          {% endfor %}
          {% set anos_tmp = (trab_por_ano.keys() | list) + (pal_por_ano.keys() | list) %}
          {% set anos_uniq = anos_tmp|unique|list %}
          {% set anos_sorted = anos_uniq|sort %}
          {% for ano in anos_sorted %}
            <tr>
              <td>{{ ano }}</td>
              <td>
                {% set lst = trab_por_ano.get(ano, []) %}
                {% if lst %}
                  <ul style="margin:0;padding-left:16px">
                    {% for r in lst %}
                      {% set st = (r.status or '')|trim|lower %}
                      <li>
                        {{ r.equipe or 'â€”' }}
                        {% if (r.coordenador or '')|trim|lower == 'sim' %}
                          <span class="pill">Coord.</span>
                        {% endif %}
                        {% if st in ['recusou','desistiu'] %}
                          <span class="pill" style="border-color:#fecaca;background:#fee2e2;color:#991b1b;margin-left:6px">{{ st|capitalize }}</span>
                          {% if r.observacao %}<span class="pill" style="margin-left:6px">{{ r.observacao }}</span>{% endif %}
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% else %} â€” {% endif %}
              </td>
              <td>
                {% set lst2 = pal_por_ano.get(ano, []) %}
                {% if lst2 %}
                  <ul style="margin:0;padding-left:16px">
                    {% for p in lst2 %}
                      <li>{{ p.palestra or '' }}</li>
                    {% endfor %}
                  </ul>
                {% else %} â€” {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Autocomplete dos nomes (apenas uma vez)
  (function(){
    const inputEle = document.getElementById('nome_ele');
    const inputEla = document.getElementById('nome_ela');
    const datalistEle = document.getElementById('sugestoes_ele');
    const datalistEla = document.getElementById('sugestoes_ela');

    function buscarNomes(input, datalist) {
      const valor = (input.value || '').trim();
      if (valor.length < 3) { datalist.innerHTML = ''; return; }
      fetch(`/autocomplete-nomes?q=${encodeURIComponent(valor)}`)
        .then(res => res.json())
        .then(data => {
          datalist.innerHTML = '';
          (data || []).forEach(nome => {
            const opt = document.createElement('option');
            opt.value = nome;
            datalist.appendChild(opt);
          });
        })
        .catch(() => {});
    }

    if (inputEle) inputEle.addEventListener('input', () => buscarNomes(inputEle, datalistEle));
    if (inputEla) inputEla.addEventListener('input', () => buscarNomes(inputEla, datalistEla));
  })();
</script>
{% endblock %}