<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Nova Montagem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --border:#e5e7eb; --ink:#0f172a; --brand:#2563eb; --danger:#b91c1c; --ok:#065f46; --warn:#92400e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg); }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px 48px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:22px; }
    .btn { appearance:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:10px; text-decoration:none; color:inherit; cursor:pointer; }
    .btn.primary { background: var(--brand); border-color: var(--brand); color:#fff; }
    .btn.danger  { border-color: var(--danger); color: var(--danger); }
    .muted { color:var(--muted); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input { padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .cols { display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:start; }
    .eq-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px}
    .eq-tag{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;text-decoration:none;color:#0f172a}
    .eq-tag small{color:#64748b}
    .eq-ok {background:#ecfdf5;border-color:#16a34a}
    .eq-warn{background:#fffbeb;border-color:#f59e0b}
    .grid-dir { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; }
    label { display:block; font-size:12px; font-weight:600; color:#334155; margin:6px 0 4px; }
    .status { margin-top:6px; font-size:13px; }
    .ok { color:var(--ok); }
    .warn-t { color:var(--warn); }
    .err { color:var(--danger); }
    .pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; margin-right:6px; }
    .help { font-size:12px; color:#475569; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Nova Montagem</h1>
        <div class="muted">Selecione o ano e monte as equipes.</div>
      </div>
      <div class="row">
        <a class="btn" href="{{ url_for('index') }}">⌂ Página Inicial</a>
        <a class="btn" href="{{ url_for('montagem') }}">↩ Voltar ao Painel</a>
      </div>
    </div>

    <!-- Seleção de Ano -->
    <div class="card" style="margin-bottom:12px;">
      <form class="row" action="{{ url_for('nova_montagem') }}" method="get">
        <label for="ano" style="margin:0; font-weight:600;">Ano</label>
        <input id="ano" name="ano" type="number" min="1990" max="2100" value="{{ ano_preselecionado or '' }}" required>
        <button class="btn primary" type="submit">Carregar</button>
        {% if ano_preselecionado %}
          <span class="pill">Ano atual: <b>{{ ano_preselecionado }}</b></span>
        {% endif %}
      </form>
    </div>

    {% if ano_preselecionado %}
    <div class="cols">
      <!-- Coluna esquerda: Status das equipes + atalhos -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Equipes — status</h3>
        <p class="help" style="margin:0 0 10px;">Verde: equipe completa · Amarelo: em andamento.</p>
        <div id="eqGrid" class="eq-grid"></div>
      </div>

      <!-- Coluna direita: Dirigentes e CG -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Dirigentes & Coordenador Geral</h3>
        <p class="help" style="margin:0 0 12px;">
          Preencha nome do casal e use <b>Buscar</b> (traz telefones/endereço). Em seguida, <b>Adicionar</b>.
        </p>

        <!-- Coordenador Geral -->
        <div class="card" style="padding:12px; margin-bottom:12px;">
          <div class="row" style="justify-content:space-between;">
            <strong>Casal Coordenador Geral</strong>
            <span class="pill">Status: Aberto</span>
          </div>
          <div class="row" style="margin-top:8px;">
            <div style="flex:1; min-width:180px;">
              <label for="cg_ele">Nome (Ele)</label>
              <input id="cg_ele" placeholder="Ex.: João" value="{{ (initial_data.cg.nome_ele if initial_data.cg) or '' }}">
            </div>
            <div style="flex:1; min-width:180px;">
              <label for="cg_ela">Nome (Ela)</label>
              <input id="cg_ela" placeholder="Ex.: Maria" value="{{ (initial_data.cg.nome_ela if initial_data.cg) or '' }}">
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div style="flex:1; min-width:180px;">
              <label for="cg_tel">Telefones</label>
              <input id="cg_tel" placeholder="Preenchido pela busca" value="{{ (initial_data.cg.telefones if initial_data.cg) or '' }}">
            </div>
            <div style="flex:1; min-width:180px;">
              <label for="cg_end">Endereço</label>
              <input id="cg_end" placeholder="Preenchido pela busca" value="{{ (initial_data.cg.endereco if initial_data.cg) or '' }}">
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="cg_buscar">Buscar</button>
            <button class="btn primary" id="cg_add">Adicionar</button>
            <div id="cg_status" class="status"></div>
          </div>
        </div>

        <!-- Dirigentes -->
        <div class="grid-dir" id="dirGrid">
          {# Serão renderizados via JS a partir de uma lista fixa + initial_data.dirigentes #}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  {% if ano_preselecionado %}
  <script>
    const ANO = {{ ano_preselecionado|int }};
    const TEAM_MAP    = {{ team_map|tojson }};
    const TEAM_LIMITS = {{ (team_limits or {})|tojson }};
    const INITIAL     = {{ initial_data|tojson }};

    // Override seguro para Sala (se por algum motivo não vier do back)
    if (!TEAM_LIMITS.Sala) TEAM_LIMITS.Sala = {min:3, max:5};

    // === Equipes (grade de status) ===
    const TEAMS = Object.entries(TEAM_MAP).map(([key, v]) => ({
      key, filtro: v.filtro, rotulo: v.rotulo
    }));

    function decorate(teamFiltro, n){
      const lim = TEAM_LIMITS[teamFiltro] || {min:0, max:8};
      const done = Number(n) >= Number(lim.max);
      return { cls: done ? 'eq-ok' : 'eq-warn', label: `${n}/${lim.max}` };
    }

    function renderBox(team, n){
      const {cls, label} = decorate(team.filtro, n);
      const href = `{{ url_for('equipe_montagem') }}?ano=${ANO}&equipe=${encodeURIComponent(team.filtro)}`;
      const a = document.createElement('a');
      a.className = `eq-tag ${cls}`;
      a.href = href;
      const subtitle = (team.filtro === 'Sala') ? 'Conta Canto, Som/Projeção e Boa Vontade' : '&nbsp;';
      const title = (team.filtro === 'Sala') ? 'Sala (sem Recepção)' : team.rotulo;
      a.innerHTML = `
        <div>
          <div><strong>${title}</strong></div>
          <small>${subtitle}</small>
        </div>
        <div><strong>${label}</strong></div>
      `;
      return a;
    }

    async function loadCounts(){
      const grid = document.getElementById('eqGrid');
      grid.innerHTML = '<div class="muted">Carregando…</div>';
      try{
        const res = await fetch(`{{ url_for('api_equipe_counts') }}?ano=${ANO}`);
        const data = await res.json();
        if (!data.ok) throw new Error('Falha ao carregar contagens');
        const counts = data.counts || {};
        grid.innerHTML = '';
        TEAMS.forEach(team => {
          const n = counts[team.filtro] ?? 0;
          grid.appendChild(renderBox(team, n));
        });
      }catch(e){
        console.error(e);
        grid.innerHTML = '<div class="muted">Não foi possível carregar as contagens.</div>';
      }
    }

    // === Coordenador Geral (CG) ===
    const $cgEle = document.getElementById('cg_ele');
    const $cgEla = document.getElementById('cg_ela');
    const $cgTel = document.getElementById('cg_tel');
    const $cgEnd = document.getElementById('cg_end');
    const $cgStatus = document.getElementById('cg_status');

    document.getElementById('cg_buscar').addEventListener('click', async (e)=>{
      e.preventDefault();
      $cgStatus.textContent='';
      const nome_ele = ($cgEle.value||'').trim();
      const nome_ela = ($cgEla.value||'').trim();
      if (!nome_ele || !nome_ela){
        $cgStatus.textContent = 'Informe Nome (Ele) e Nome (Ela).'; $cgStatus.className='status warn-t'; return;
      }
      try{
        const r = await fetch('{{ url_for("api_buscar_cg") }}', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome_ele, nome_ela })
        });
        const j = await r.json();
        if (!j.ok){ $cgStatus.textContent = j.msg || 'Não encontrado.'; $cgStatus.className='status err'; return; }
        $cgTel.value = j.telefones || '';
        $cgEnd.value = j.endereco || '';
        $cgStatus.textContent = 'Dados carregados.'; $cgStatus.className='status ok';
      }catch{ $cgStatus.textContent='Erro ao buscar.'; $cgStatus.className='status err'; }
    });

    document.getElementById('cg_add').addEventListener('click', async (e)=>{
      e.preventDefault();
      $cgStatus.textContent='';
      const nome_ele = ($cgEle.value||'').trim();
      const nome_ela = ($cgEla.value||'').trim();
      const telefones = ($cgTel.value||'').trim();
      const endereco  = ($cgEnd.value||'').trim();
      if (!nome_ele || !nome_ela){
        $cgStatus.textContent = 'Informe Nome (Ele) e Nome (Ela).'; $cgStatus.className='status warn-t'; return;
      }
      try{
        const r = await fetch('{{ url_for("api_adicionar_cg") }}', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ano: ANO, nome_ele, nome_ela, telefones, endereco })
        });
        const j = await r.json();
        if (!j.ok){ $cgStatus.textContent = j.msg || 'Falha ao adicionar.'; $cgStatus.className='status err'; return; }
        $cgStatus.textContent = 'CG adicionado com sucesso.'; $cgStatus.className='status ok';
        loadCounts();
      }catch{ $cgStatus.textContent='Erro ao adicionar.'; $cgStatus.className='status err'; }
    });

    // === Dirigentes ===
    // Lista canônica (precisa bater com o backend)
    const DIRS = [
      "Equipe Dirigente - MONTAGEM",
      "Equipe Dirigente -FICHAS",
      "Equipe Dirigente - FINANÇAS",
      "Equipe Dirigente - PALESTRA",
      "Equipe Dirigente - PÓS ENCONTRO",
    ];

    function dirigenteCard(equipe, pref){
      const box = document.createElement('div');
      box.className = 'card';
      box.style.padding='12px';

      const id = equipe.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');

      box.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <strong>${equipe}</strong>
          <span class="pill">Coordenador</span>
        </div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1; min-width:160px;">
            <label for="${id}_ele">Nome (Ele)</label>
            <input id="${id}_ele" placeholder="Ex.: João" value="${pref?.nome_ele||''}">
          </div>
          <div style="flex:1; min-width:160px;">
            <label for="${id}_ela">Nome (Ela)</label>
            <input id="${id}_ela" placeholder="Ex.: Maria" value="${pref?.nome_ela||''}">
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1; min-width:160px;">
            <label for="${id}_tel">Telefones</label>
            <input id="${id}_tel" placeholder="Preenchido pela busca" value="${pref?.telefones||''}">
          </div>
          <div style="flex:1; min-width:160px;">
            <label for="${id}_end">Endereço</label>
            <input id="${id}_end" placeholder="Preenchido pela busca" value="${pref?.endereco||''}">
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="${id}_buscar">Buscar</button>
          <button class="btn primary" id="${id}_add">Adicionar</button>
          <div id="${id}_status" class="status"></div>
        </div>
      `;

      // Handlers
      const $ele = box.querySelector(`#${id}_ele`);
      const $ela = box.querySelector(`#${id}_ela`);
      const $tel = box.querySelector(`#${id}_tel`);
      const $end = box.querySelector(`#${id}_end`);
      const $st  = box.querySelector(`#${id}_status`);

      box.querySelector(`#${id}_buscar`).addEventListener('click', async (e)=>{
        e.preventDefault();
        $st.textContent='';
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        if (!nome_ele || !nome_ela){
          $st.textContent='Informe Nome (Ele) e Nome (Ela).'; $st.className='status warn-t'; return;
        }
        try{
          const r = await fetch('{{ url_for("api_buscar_casal") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ nome_ele, nome_ela })
          });
          const j = await r.json();
          if (!j.ok){ $st.textContent = j.msg || 'Não encontrado.'; $st.className='status err'; return; }
          $tel.value = j.telefones || '';
          $end.value = j.endereco || '';
          $st.textContent = `Dados carregados (${j.origem}).`; $st.className='status ok';
        }catch{ $st.textContent='Erro ao buscar.'; $st.className='status err'; }
      });

      box.querySelector(`#${id}_add`).addEventListener('click', async (e)=>{
        e.preventDefault();
        $st.textContent='';
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        const telefones = ($tel.value||'').trim();
        const endereco  = ($end.value||'').trim();
        if (!nome_ele || !nome_ela){
          $st.textContent='Informe Nome (Ele) e Nome (Ela).'; $st.className='status warn-t'; return;
        }
        try{
          const r = await fetch('{{ url_for("api_adicionar_dirigente") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ano: ANO, equipe, nome_ele, nome_ela, telefones, endereco })
          });
          const j = await r.json();
          if (!j.ok){ $st.textContent = j.msg || 'Falha ao adicionar.'; $st.className='status err'; return; }
          $st.textContent = 'Dirigente adicionado com sucesso.'; $st.className='status ok';
          loadCounts();
        }catch{ $st.textContent='Erro ao adicionar.'; $st.className='status err'; }
      });

      return box;
    }

    function renderDirigentes(){
      const grid = document.getElementById('dirGrid');
      grid.innerHTML = '';
      const prefMap = INITIAL?.dirigentes || {};
      DIRS.forEach(eq => {
        grid.appendChild(dirigenteCard(eq, prefMap[eq]));
      });
    }

    // Boot
    loadCounts();
    renderDirigentes();
  </script>
  {% endif %}
</body>
</html>
