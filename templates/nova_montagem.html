<script>
  const initialData = {{ (initial_data or {}) | tojson }};
  const anoPre = {{ (ano_preselecionado or 'null') }};
  const equipes = [
    "Equipe Dirigente - MONTAGEM",
    "Equipe Dirigente -FICHAS",
    "Equipe Dirigente - FINANÇAS",
    "Equipe Dirigente - PALESTRA",
    "Equipe Dirigente - PÓS ENCONTRO",
  ];

  const grid = document.getElementById('dirigentes-grid');
  const anoInput = document.getElementById('ano');
  const btnContinuar = document.getElementById('btn-continuar');
  const anoMsg = document.getElementById('ano-msg');
  const kpi = document.getElementById('kpi-total');
  const kpiDone = document.getElementById('kpi-done');
  const cg = document.getElementById('coordenador-geral');

  // CG elements
  const cgEle = document.getElementById('cg_nome_ele');
  const cgEla = document.getElementById('cg_nome_ela');
  const cgTel = document.getElementById('cg_telefones');
  const cgEnd = document.getElementById('cg_endereco');
  const cgBuscar = document.getElementById('cg_buscar');
  const cgAdd = document.getElementById('cg_add');
  const cgStatus = document.getElementById('cg_status');

  let anoSelecionado = null;
  let totalAdicionados = 0;

  function idFromEquipe(equipe) {
    return equipe.replace(/[^a-z0-9]+/gi, '_');
  }

  function makeModal(onChoose) {
    // modal simples
    const m = document.createElement('div');
    m.style.position = 'fixed';
    m.style.inset = '0';
    m.style.background = 'rgba(0,0,0,.35)';
    m.style.display = 'flex';
    m.style.alignItems = 'center';
    m.style.justifyContent = 'center';
    m.innerHTML = `
      <div style="background:#fff; padding:16px; border-radius:12px; width:90%; max-width:360px;">
        <div style="font-weight:600; margin-bottom:8px;">O Casal…</div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="m_rec" class="btn">Recusou</button>
          <button id="m_des" class="btn">Desistiu</button>
        </div>
      </div>
    `;
    document.body.appendChild(m);
    m.querySelector('#m_rec').onclick = () => { onChoose('Recusou'); document.body.removeChild(m); };
    m.querySelector('#m_des').onclick = () => { onChoose('Desistiu'); document.body.removeChild(m); };
  }

  function renderCaixa(equipe, preset) {
    const idSafe = idFromEquipe(equipe);
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <h3 style="margin:0 0 8px;">${equipe}</h3>
      <div class="row">
        <div>
          <label for="${idSafe}_ele">Nome (Ele)</label>
          <input id="${idSafe}_ele" placeholder="Ex.: João" value="${preset?.nome_ele || ''}">
        </div>
        <div>
          <label for="${idSafe}_ela">Nome (Ela)</label>
          <input id="${idSafe}_ela" placeholder="Ex.: Maria" value="${preset?.nome_ela || ''}">
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="${idSafe}_telefones">Telefones</label>
          <input id="${idSafe}_telefones" placeholder="Preenchido pela busca (editável)" value="${preset?.telefones || ''}">
        </div>
        <div>
          <label for="${idSafe}_endereco">Endereço</label>
          <input id="${idSafe}_endereco" placeholder="Preenchido pela busca (editável)" value="${preset?.endereco || ''}">
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn" id="${idSafe}_buscar">Buscar</button>
        <button class="btn primary" id="${idSafe}_action">${preset?.id ? 'Alterar' : 'Adicionar'}</button>
      </div>

      <div class="status" id="${idSafe}_status"></div>
    `;

    setTimeout(() => {
      const $ele = document.getElementById(`${idSafe}_ele`);
      const $ela = document.getElementById(`${idSafe}_ela`);
      const $tels = document.getElementById(`${idSafe}_telefones`);
      const $end = document.getElementById(`${idSafe}_endereco`);
      const $buscar = document.getElementById(`${idSafe}_buscar`);
      const $action = document.getElementById(`${idSafe}_action`);
      const $status = document.getElementById(`${idSafe}_status`);

      let currentId = preset?.id || null;
      let isLocked = !!preset?.id;

      function lockCard() {
        $ele.disabled = true; $ela.disabled = true;
        $tels.disabled = true; $end.disabled = true;
        $buscar.disabled = true;
        isLocked = true;
      }
      function unlockAndClearCard() {
        $ele.disabled = false; $ela.disabled = false;
        $tels.disabled = false; $end.disabled = false;
        $buscar.disabled = false;
        $ele.value = ''; $ela.value = ''; $tels.value = ''; $end.value = '';
        currentId = null;
        isLocked = false;
      }

      if (isLocked) {
        // já existia registro deste ano -> conta e trava
        totalAdicionados += 1;
        kpiDone.textContent = String(totalAdicionados);
        lockCard();
      }

      async function buscar() {
        $status.textContent = '';
        const nome_ele = ($ele.value || '').trim();
        const nome_ela = ($ela.value || '').trim();
        if (!nome_ele || !nome_ela) {
          $status.textContent = 'Preencha Nome (Ele) e Nome (Ela) para buscar.';
          $status.className = 'status warn';
          return;
        }
        try {
          const resp = await fetch('{{ url_for("api_buscar_casal") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nome_ele, nome_ela })
          });
          const data = await resp.json();
          if (data.ok) {
            $tels.value = data.telefones || '';
            $end.value = data.endereco || '';
            $status.textContent = `Dados carregados de ${data.origem}.`;
            $status.className = 'status ok';
          } else {
            $status.textContent = data.msg || 'Não encontrado.';
            $status.className = 'status err';
          }
        } catch(e) {
          $status.textContent = 'Erro ao buscar dados.';
          $status.className = 'status err';
        }
      }

      async function adicionar() {
        $status.textContent = '';
        const nome_ele = ($ele.value || '').trim();
        const nome_ela = ($ela.value || '').trim();
        const telefones = ($tels.value || '').trim();
        const endereco = ($end.value || '').trim();
        if (!anoSelecionado) {
          $status.textContent = 'Informe o ano antes.';
          $status.className = 'status warn';
          return;
        }
        if (!nome_ele || !nome_ela) {
          $status.textContent = 'Preencha Nome (Ele) e Nome (Ela).';
          $status.className = 'status warn';
          return;
        }
        try {
          const resp = await fetch('{{ url_for("api_adicionar_dirigente") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              ano: anoSelecionado,
              equipe: `${equipe}`,
              nome_ele, nome_ela, telefones, endereco
            })
          });
          const data = await resp.json();
          if (data.ok) {
            currentId = data.id;
            $status.textContent = 'Adicionado com sucesso.';
            $status.className = 'status ok';
            lockCard();
            $action.textContent = 'Alterar';
            totalAdicionados += 1;
            kpiDone.textContent = String(totalAdicionados);
            maybeEnableCG();
          } else {
            $status.textContent = data.msg || 'Falha ao adicionar.';
            $status.className = 'status err';
          }
        } catch(e) {
          $status.textContent = 'Erro ao adicionar.';
          $status.className = 'status err';
        }
      }

      async function alterarCom(statusEscolhido) {
        if (!currentId) return;
        try {
          const resp = await fetch('{{ url_for("api_marcar_status") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: currentId, status: statusEscolhido })
          });
          const data = await resp.json();
          if (data.ok) {
            $status.textContent = `Registro marcado como "${statusEscolhido}". Campos liberados para novo cadastro.`;
            $status.className = 'status ok';
            // libera p/ novo
            unlockAndClearCard();
            $action.textContent = 'Adicionar';
            // se estava contado como adicionado, decrementa para refletir necessidade de preencher novamente
            if (totalAdicionados > 0) {
              totalAdicionados -= 1;
              kpiDone.textContent = String(totalAdicionados);
            }
          } else {
            $status.textContent = data.msg || 'Falha ao alterar status.';
            $status.className = 'status err';
          }
        } catch (e) {
          $status.textContent = 'Erro ao alterar status.';
          $status.className = 'status err';
        }
      }

      $buscar.addEventListener('click', (e) => { e.preventDefault(); buscar(); });
      $action.addEventListener('click', (e) => {
        e.preventDefault();
        if (!isLocked) {
          adicionar();
        } else {
          makeModal((choice) => alterarCom(choice));
        }
      });
    }, 0);

    return el;
  }

  function renderCGPresetIfAny() {
    if (initialData && initialData.cg) {
      cgEle.value = initialData.cg.nome_ele || '';
      cgEla.value = initialData.cg.nome_ela || '';
      cgTel.value = initialData.cg.telefones || '';
      cgEnd.value = initialData.cg.endereco || '';
      cgStatus.textContent = 'Já existe “Casal Coordenador Geral” para este ano.';
      cgStatus.className = 'status warn';
      // já considerado "ocupado" – não permite duplicar
    }
  }

  function maybeEnableCG() {
    if (totalAdicionados >= 5) {
      cg.style.display = '';
      cg.classList.remove('disabled');
      if (!initialData.cg) {
        cgEle.disabled = false;
        cgEla.disabled = false;
        cgBuscar.disabled = false;
        cgAdd.disabled = false;
        cgEle.placeholder = 'Nome (Ele)';
        cgEla.placeholder = 'Nome (Ela)';
      }
    }
  }

  btnContinuar.addEventListener('click', (e) => {
    e.preventDefault();
    const val = (anoInput.value || '').trim();
    if (!/^\d{4}$/.test(val)) {
      anoMsg.textContent = 'Informe um ano válido (YYYY).';
      anoMsg.className = 'status err';
      return;
    }
    anoSelecionado = parseInt(val, 10);
    anoMsg.textContent = `Ano selecionado: ${anoSelecionado}`;
    anoMsg.className = 'status ok';
    grid.innerHTML = '';

    totalAdicionados = 0;
    kpiDone.textContent = '0';
    kpi.style.display = '';

    equipes.forEach(eq => {
      const preset = (initialData.dirigentes && initialData.dirigentes[eq]) ? initialData.dirigentes[eq] : null;
      grid.appendChild(renderCaixa(eq, preset));
    });

    document.getElementById('dirigentes-grid').style.display = '';

    if (initialData && initialData.dirigentes) {
      const nPre = Object.keys(initialData.dirigentes).length;
      totalAdicionados = nPre;
      kpiDone.textContent = String(totalAdicionados);
    }

    cg.style.display = '';
    renderCGPresetIfAny();
    maybeEnableCG();
  });

  window.addEventListener('DOMContentLoaded', () => {
    if (anoPre) {
      btnContinuar.click();
    }
  });

  // ----- CG handlers (com fluxo de bloquear/inserir) -----
  cgBuscar.addEventListener('click', async (e) => {
    e.preventDefault();
    cgStatus.textContent = '';
    const nome_ele = (cgEle.value || '').trim();
    const nome_ela = (cgEla.value || '').trim();
    if (!nome_ele || !nome_ela) {
      cgStatus.textContent = 'Preencha Nome (Ele) e Nome (Ela).';
      cgStatus.className = 'status warn';
      return;
    }
    try {
      const resp = await fetch('{{ url_for("api_buscar_cg") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ nome_ele, nome_ela })
      });
      const data = await resp.json();
      if (data.ok) {
        cgTel.value = data.telefones || '';
        cgEnd.value = data.endereco || '';
        cgStatus.textContent = 'Dados carregados. Casal é elegível para CG.';
        cgStatus.className = 'status ok';
      } else {
        cgStatus.textContent = data.msg || 'Não permitido.';
        cgStatus.className = 'status err';
      }
    } catch (err) {
      cgStatus.textContent = 'Erro ao buscar.';
      cgStatus.className = 'status err';
    }
  });

  cgAdd.addEventListener('click', async (e) => {
    e.preventDefault();
    cgStatus.textContent = '';
    const nome_ele = (cgEle.value || '').trim();
    const nome_ela = (cgEla.value || '').trim();
    const telefones = (cgTel.value || '').trim();
    const endereco = (cgEnd.value || '').trim();
    if (!anoSelecionado) {
      cgStatus.textContent = 'Informe o ano antes.';
      cgStatus.className = 'status warn';
      return;
    }
    if (!nome_ele || !nome_ela) {
      cgStatus.textContent = 'Preencha Nome (Ele) e Nome (Ela).';
      cgStatus.className = 'status warn';
      return;
    }
    try {
      const resp = await fetch('{{ url_for("api_adicionar_cg") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ano: anoSelecionado,
          nome_ele, nome_ela, telefones, endereco
        })
      });
      const data = await resp.json();
      if (data.ok) {
        cgStatus.textContent = 'Casal Coordenador Geral adicionado com sucesso.';
        cgStatus.className = 'status ok';
        cgEle.disabled = true; cgEla.disabled = true;
        cgTel.disabled = true; cgEnd.disabled = true;
        cgBuscar.disabled = true; cgAdd.disabled = true;
      } else {
        cgStatus.textContent = data.msg || 'Falha ao adicionar.';
        cgStatus.className = 'status err';
      }
    } catch (err) {
      cgStatus.textContent = 'Erro ao adicionar.';
      cgStatus.className = 'status err';
    }
  });
</script>
