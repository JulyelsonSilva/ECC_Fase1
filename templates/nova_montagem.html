<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Nova Montagem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --border:#e5e7eb; --ink:#0f172a; --brand:#2563eb; --danger:#b91c1c; --warn:#92400e; --ok:#065f46; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg); }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 12px; flex-wrap: wrap; }
    h1 { margin:0; font-size: 22px; }
    .muted { color:var(--muted); }
    .btn { appearance:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; color:inherit; }
    .btn.primary { background: var(--brand); color:#fff; border-color: var(--brand); }
    .btn.danger { background: var(--danger); color:#fff; border-color: var(--danger); }
    .btn.ghost { background:transparent; }
    .btn.small { padding:6px 10px; border-radius:8px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    label { display:block; font-size: 12px; font-weight:600; color:#334155; margin-bottom:6px; }
    input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; }
    textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; resize: vertical; }
    .row { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .row-3 { display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr; }
    .status { margin-top:8px; font-size:13px; }
    .ok { color:var(--ok); }
    .warn { color:var(--warn); }
    .err { color:var(--danger); }
    .disabled { opacity:.6; pointer-events:none; }
    .section-title { margin: 18px 0 8px; font-size: 16px; font-weight: 700; }
    .kpi { font-size:13px; color:#334155; margin:6px 0 12px; }
    .team-link { display:block; padding:12px; border:1px dashed var(--border); border-radius:10px; text-align:center; cursor:pointer; user-select:none; }
    .team-link:hover { background:#f1f5f9; }
    .inline-choices { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .note { font-size:12px; color:var(--muted); margin-top:6px; }
    .choice-box { border:1px dashed var(--border); border-radius:10px; padding:12px; margin-top:8px; background:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Nova Montagem</h1>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('montagem') }}">← Montagem</a>
        <a class="btn" href="{{ url_for('index') }}">⌂ Página Inicial</a>
        <button class="btn primary" id="btn-concluir-ano" style="display:none;">Concluir Montagem do Ano</button>
      </div>
    </div>

    <p class="muted">Informe o ano, adicione os 5 Dirigentes e o <strong>Coordenador Geral</strong>. Depois selecione os <strong>Coordenadores de Equipe</strong> e, por fim, conclua a montagem do ano.</p>

    <!-- Passo 1: Ano -->
    <div class="card" id="ano-card">
      <label for="ano">Ano do Encontro</label>
      <div class="row">
        <input id="ano" type="number" inputmode="numeric" placeholder="Ex.: 2025" value="{{ ano_preselecionado or '' }}">
        <button class="btn primary" id="btn-continuar">Continuar</button>
      </div>
      <div class="status" id="ano-msg"></div>
    </div>

    <!-- Indicador Dirigentes -->
    <p class="kpi" id="kpi-total" style="display:none;">Dirigentes adicionados: <b id="kpi-done">0</b>/5</p>

    <!-- Passo 2: 5 caixas Dirigentes -->
    <div class="grid" id="dirigentes-grid" style="display:none;"></div>

    <!-- Coordenador Geral -->
    <div class="card disabled" id="coordenador-geral" style="margin-top:12px; display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
        <h3 style="margin:0;">Coordenador Geral</h3>
        <div id="cg-actions" style="display:flex; gap:8px;"></div>
      </div>
      <div class="row">
        <div>
          <label for="cg_nome_ele">Nome (Ele)</label>
          <input id="cg_nome_ele" placeholder="— habilita após 5/5 —" disabled>
        </div>
        <div>
          <label for="cg_nome_ela">Nome (Ela)</label>
          <input id="cg_nome_ela" placeholder="— habilita após 5/5 —" disabled>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div>
          <label for="cg_telefones">Telefones</label>
          <input id="cg_telefones" placeholder="(preenchido pela busca)" disabled>
        </div>
        <div>
          <label for="cg_endereco">Endereço</label>
          <input id="cg_endereco" placeholder="(preenchido pela busca)" disabled>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="cg_buscar" disabled>Buscar</button>
        <button class="btn primary" id="cg_add" disabled>Adicionar</button>
      </div>
      <div class="status" id="cg_status"></div>
      <p class="note">Regra: o casal precisa <strong>já ter trabalhado</strong> no ECC e <strong>nunca ter sido</strong> “Casal Coordenador Geral”.</p>
    </div>

    <!-- Coordenadores de Equipe (aparece só após CG escolhido) -->
    <div id="coords-section" style="display:none;">
      <h3 class="section-title">Coordenadores de Equipe</h3>
      <p class="note" id="coords-note">Clique no nome da equipe para abrir a Visão de Equipes e escolher um casal (somente casais que nunca foram coordenadores aparecem como link).</p>
      <div class="grid" id="coords-grid"></div>
    </div>
  </div>

  <script>
    // =========================
    // Dados vindos do servidor
    // =========================
    const initialData = {{ initial_data | tojson }};
    const anoPre = {{ ano_preselecionado | tojson }};
    const TEAM_MAP = {{ team_map | tojson }};

    const equipesDirigentes = [
      "Equipe Dirigente - MONTAGEM",
      "Equipe Dirigente -FICHAS",
      "Equipe Dirigente - FINANÇAS",
      "Equipe Dirigente - PALESTRA",
      "Equipe Dirigente - PÓS ENCONTRO",
    ];

    // =========================
    // Utils
    // =========================
    function idFromLabel(lbl) { return lbl.replace(/[^a-z0-9]+/gi, '_'); }
    function makeEl(html) { const d=document.createElement('div'); d.innerHTML = html.trim(); return d.firstElementChild; }
    function setDisabled(el, val) { el.disabled = !!val; }
    function show(el, on=true) { el.style.display = on ? '' : 'none'; }
    function statusText(el, msg, cls='') { el.textContent = msg || ''; el.className = 'status ' + (cls||''); }
    // ✅ Helper compatível para inserir após um nó (evita usar .after())
    function insertAfter(referenceNode, newNode) {
      if (referenceNode && referenceNode.parentNode) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
      } else {
        document.body.appendChild(newNode);
      }
    }

    // =========================
    // Elementos principais
    // =========================
    const grid = document.getElementById('dirigentes-grid');
    const anoInput = document.getElementById('ano');
    const btnContinuar = document.getElementById('btn-continuar');
    const anoMsg = document.getElementById('ano-msg');
    const kpi = document.getElementById('kpi-total');
    const kpiDone = document.getElementById('kpi-done');
    const cgCard = document.getElementById('coordenador-geral');
    const coordsSection = document.getElementById('coords-section');
    const coordsGrid = document.getElementById('coords-grid');
    const btnConcluirAno = document.getElementById('btn-concluir-ano');

    // CG elements
    const cgEle = document.getElementById('cg_nome_ele');
    const cgEla = document.getElementById('cg_nome_ela');
    const cgTel = document.getElementById('cg_telefones');
    const cgEnd = document.getElementById('cg_endereco');
    const cgBuscar = document.getElementById('cg_buscar');
    const cgAdd = document.getElementById('cg_add');
    const cgStatus = document.getElementById('cg_status');

    // =========================
    // Estado
    // =========================
    let anoSelecionado = null;
    let totalDirigentesAdicionados = 0;
    let cgId = null;  // id do registro CG em aberto
    let cgAdded = false;

    // =========================
    // Caixa de escolha (Recusou/Desistiu) c/ justificativa obrigatória
    // =========================
    function buildStatusChoice(onConfirm) {
      const box = makeEl(`
        <div class="choice-box">
          <div class="inline-choices">
            <button class="btn small" data-val="Recusou">Recusou</button>
            <button class="btn small" data-val="Desistiu">Desistiu</button>
            <button class="btn small ghost" data-val="cancel">Cancelar</button>
          </div>
          <div class="just-box" style="margin-top:8px; display:none;">
            <label>Justificativa</label>
            <textarea rows="3" placeholder="Descreva a justificativa..."></textarea>
            <div class="inline-choices" style="margin-top:8px;">
              <button class="btn small primary" data-action="confirm">Confirmar</button>
              <button class="btn small" data-action="back">Voltar</button>
            </div>
            <div class="status" style="margin-top:6px;"></div>
          </div>
        </div>
      `);

      const btns = box.querySelectorAll('button[data-val]');
      const justBox = box.querySelector('.just-box');
      const ta = justBox.querySelector('textarea');
      const st = justBox.querySelector('.status');

      let picked = null;

      btns.forEach(b=>{
        b.addEventListener('click', e=>{
          e.preventDefault();
          const val = b.getAttribute('data-val');
          if (val === 'cancel') { box.remove(); return; }
          picked = val;
          justBox.style.display = '';
          ta.focus();
        });
      });

      justBox.querySelector('button[data-action="back"]').addEventListener('click', (e)=>{
        e.preventDefault();
        picked = null;
        justBox.style.display = 'none';
        st.textContent = '';
      });

      justBox.querySelector('button[data-action="confirm"]').addEventListener('click', (e)=>{
        e.preventDefault();
        const obs = (ta.value || '').trim();
        if (!obs) { st.textContent = 'A justificativa é obrigatória.'; st.className = 'status err'; return; }
        onConfirm(picked, obs, box);
      });

      return box;
    }

    // =========================
    // DIRIGENTES
    // =========================
    function renderDirigenteCard(equipe, preset) {
      const idSafe = idFromLabel(equipe);
      const card = makeEl(`
        <div class="card" id="${idSafe}_card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <h3 style="margin:0;">${equipe}</h3>
          </div>

          <div class="row">
            <div>
              <label for="${idSafe}_ele">Nome (Ele)</label>
              <input id="${idSafe}_ele" placeholder="Ex.: João" value="${preset?.nome_ele || ''}">
            </div>
            <div>
              <label for="${idSafe}_ela">Nome (Ela)</label>
              <input id="${idSafe}_ela" placeholder="Ex.: Maria" value="${preset?.nome_ela || ''}">
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label for="${idSafe}_telefones">Telefones</label>
              <input id="${idSafe}_telefones" placeholder="Preenchido pela busca (editável)" value="${preset?.telefones || ''}">
            </div>
            <div>
              <label for="${idSafe}_endereco">Endereço</label>
              <input id="${idSafe}_endereco" placeholder="Preenchido pela busca (editável)" value="${preset?.endereco || ''}">
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <button class="btn" id="${idSafe}_buscar">Buscar</button>
            <button class="btn primary" id="${idSafe}_add">Adicionar</button>
          </div>

          <div class="status" id="${idSafe}_status"></div>
        </div>
      `);

      const $ele = card.querySelector(`#${idSafe}_ele`);
      const $ela = card.querySelector(`#${idSafe}_ela`);
      const $tels = card.querySelector(`#${idSafe}_telefones`);
      const $end = card.querySelector(`#${idSafe}_endereco`);
      const $buscar = card.querySelector(`#${idSafe}_buscar`);
      const $add = card.querySelector(`#${idSafe}_add`);
      const $status = card.querySelector(`#${idSafe}_status`);

      let recId = preset?.id || null;
      let locked = false;

      function lockBox(on) {
        [$ele,$ela,$tels,$end,$buscar].forEach(el=>setDisabled(el,on));
        $add.textContent = on ? 'Alterar' : 'Adicionar';
        locked = on;
      }

      async function buscar() {
        statusText($status,'','');
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        if (!nome_ele || !nome_ela) { return statusText($status,'Preencha Nome (Ele) e Nome (Ela).','warn'); }
        try {
          const resp = await fetch('{{ url_for("api_buscar_casal") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ nome_ele, nome_ela })
          });
          const data = await resp.json();
          if (data.ok) {
            $tels.value = data.telefones || '';
            $end.value = data.endereco || '';
            statusText($status, `Dados carregados de ${data.origem}.`, 'ok');
          } else {
            statusText($status, data.msg || 'Não encontrado.', 'err');
          }
        } catch { statusText($status,'Erro ao buscar.','err'); }
      }

      async function adicionar() {
        statusText($status,'','');
        if (!anoSelecionado) return statusText($status,'Informe o ano antes.','warn');
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        const telefones = ($tels.value||'').trim();
        const endereco = ($end.value||'').trim();
        if (!nome_ele || !nome_ela) return statusText($status,'Preencha Nome (Ele) e Nome (Ela).','warn');

        try {
          const resp = await fetch('{{ url_for("api_adicionar_dirigente") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ano: anoSelecionado, equipe: equipe, nome_ele, nome_ela, telefones, endereco })
          });
          const data = await resp.json();
          if (data.ok) {
            recId = data.id || recId;
            statusText($status,'Adicionado com sucesso.','ok');
            lockBox(true);
            totalDirigentesAdicionados += 1;
            kpiDone.textContent = String(totalDirigentesAdicionados);
            maybeEnableCG();
          } else {
            statusText($status, data.msg || 'Falha ao adicionar.','err');
          }
        } catch { statusText($status,'Erro ao adicionar.','err'); }
      }

      function askAlterar() {
        if (!recId) return;
        card.querySelectorAll('.choice-box').forEach(n=>n.remove()); // evita duplicar
        const chooser = buildStatusChoice(async (choice, justificativa, boxEl)=>{
          try {
            const resp = await fetch('{{ url_for("api_marcar_status") }}', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ id: recId, status: choice, observacao: justificativa })
            });
            const data = await resp.json();
            if (data.ok) {
              statusText($status, `Status alterado para “${choice}”. Preencha novos dados e clique em Adicionar.`, 'ok');
              lockBox(false);
              [$ele,$ela,$tels,$end].forEach(i=>i.value='');
              recId = null;
              if (totalDirigentesAdicionados>0) {
                totalDirigentesAdicionados -= 1;
                kpiDone.textContent = String(totalDirigentesAdicionados);
              }
              boxEl.remove();
              maybeEnableCG();
            } else {
              statusText($status, data.msg || 'Falha ao alterar.','err');
            }
          } catch { statusText($status,'Erro ao alterar.','err'); }
        });
        insertAfter($status, chooser);
      }

      $buscar.addEventListener('click', e=>{ e.preventDefault(); buscar(); });
      $add.addEventListener('click', e=>{
        e.preventDefault();
        if (!locked) adicionar();
        else askAlterar();
      });

      if (preset && (preset.nome_ele || preset.nome_ela)) {
        lockBox(true);
        totalDirigentesAdicionados += 1;
        kpiDone.textContent = String(totalDirigentesAdicionados);
      }

      return card;
    }

    function renderDirigentes() {
      grid.innerHTML = '';
      equipesDirigentes.forEach(eq=>{
        const preset = (initialData.dirigentes && initialData.dirigentes[eq]) ? initialData.dirigentes[eq] : null;
        grid.appendChild(renderDirigenteCard(eq, preset));
      });
      show(grid, true);
      show(kpi, true);
    }

    function maybeEnableCG() {
      if (totalDirigentesAdicionados >= 5) {
        show(cgCard, true);
        cgCard.classList.remove('disabled');
        if (!cgAdded) {
          setDisabled(cgEle, false);
          setDisabled(cgEla, false);
          setDisabled(cgBuscar, false);
          setDisabled(cgAdd, false);
          setDisabled(cgTel, false);
          setDisabled(cgEnd, false);
          cgEle.placeholder = 'Nome (Ele)';
          cgEla.placeholder = 'Nome (Ela)';
        }
      } else {
        if (!cgAdded) {
          show(cgCard, true);
          cgCard.classList.add('disabled');
          setDisabled(cgEle, true);
          setDisabled(cgEla, true);
          setDisabled(cgBuscar, true);
          setDisabled(cgAdd, true);
          setDisabled(cgTel, true);
          setDisabled(cgEnd, true);
          cgEle.placeholder = '— habilita após 5/5 —';
          cgEla.placeholder = '— habilita após 5/5 —';
        }
      }
    }

    // =========================
    // COORDENADOR GERAL
    // =========================
    function renderCGPresetIfAny() {
      if (initialData && initialData.cg) {
        cgId = initialData.cg.id || null;
        cgAdded = true;
        cgEle.value = initialData.cg.nome_ele || '';
        cgEla.value = initialData.cg.nome_ela || '';
        cgTel.value = initialData.cg.telefones || '';
        cgEnd.value = initialData.cg.endereco || '';

        setDisabled(cgEle, true);
        setDisabled(cgEla, true);
        setDisabled(cgTel, true);
        setDisabled(cgEnd, true);
        setDisabled(cgBuscar, true);
        setDisabled(cgAdd, false);
        cgAdd.textContent = 'Alterar';
        cgCard.classList.remove('disabled');
        statusText(cgStatus,'Coordenador Geral em aberto para este ano.','ok');

        show(coordsSection, true);
        renderCoordsGrid();
      }
    }

    async function cgBuscarHandler() {
      statusText(cgStatus,'','');
      const nome_ele = (cgEle.value||'').trim();
      const nome_ela = (cgEla.value||'').trim();
      if (!nome_ele || !nome_ela) return statusText(cgStatus,'Preencha Nome (Ele) e Nome (Ela).','warn');

      try {
        const resp = await fetch('{{ url_for("api_buscar_cg") }}', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome_ele, nome_ela })
        });
        const data = await resp.json();
        if (data.ok) {
          cgTel.value = data.telefones || '';
          cgEnd.value = data.endereco || '';
          statusText(cgStatus, 'Dados carregados. Casal é elegível para CG.', 'ok');
        } else {
          statusText(cgStatus, data.msg || 'Não permitido.', 'err');
        }
      } catch { statusText(cgStatus, 'Erro ao buscar.', 'err'); }
    }

    function cgAskAlterar() {
      if (!cgId) return;
      cgCard.querySelectorAll('.choice-box').forEach(n=>n.remove());
      const chooser = buildStatusChoice(async (choice, justificativa, boxEl)=>{
        try {
          const resp = await fetch('{{ url_for("api_marcar_status") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id: cgId, status: choice, observacao: justificativa })
          });
          const data = await resp.json();
          if (data.ok) {
            statusText(cgStatus, `Status alterado para “${choice}”. Preencha novos dados e clique em Adicionar.`, 'ok');
            cgAdded = false; cgId = null;
            setDisabled(cgEle, false);
            setDisabled(cgEla, false);
            setDisabled(cgBuscar, false);
            setDisabled(cgAdd, false);
            setDisabled(cgTel, false);
            setDisabled(cgEnd, false);
            cgAdd.textContent = 'Adicionar';
            cgEle.value = ''; cgEla.value = ''; cgTel.value = ''; cgEnd.value = '';
            show(coordsSection, false);
            boxEl.remove();
          } else {
            statusText(cgStatus, data.msg || 'Falha ao alterar.', 'err');
          }
        } catch { statusText(cgStatus, 'Erro ao alterar.', 'err'); }
      });
      insertAfter(cgStatus, chooser);
    }

    async function cgAddOrAlter() {
      if (!anoSelecionado) return statusText(cgStatus,'Informe o ano antes.','warn');
      if (cgAdded && cgId) { cgAskAlterar(); return; }

      const nome_ele = (cgEle.value||'').trim();
      const nome_ela = (cgEla.value||'').trim();
      const telefones = (cgTel.value||'').trim();
      const endereco = (cgEnd.value||'').trim();
      if (!nome_ele || !nome_ela) return statusText(cgStatus,'Preencha Nome (Ele) e Nome (Ela).','warn');

      try {
        const resp = await fetch('{{ url_for("api_adicionar_cg") }}', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ano: anoSelecionado, nome_ele, nome_ela, telefones, endereco })
        });
        const data = await resp.json();
        if (data.ok) {
          cgId = data.id || null;
          cgAdded = true;
          setDisabled(cgEle, true);
          setDisabled(cgEla, true);
          setDisabled(cgBuscar, true);
          setDisabled(cgAdd, false);
          setDisabled(cgTel, true);
          setDisabled(cgEnd, true);
          cgAdd.textContent = 'Alterar';
          statusText(cgStatus, 'Casal Coordenador Geral adicionado com sucesso.', 'ok');
          show(coordsSection, true);
          renderCoordsGrid();
        } else {
          statusText(cgStatus, data.msg || 'Falha ao adicionar.', 'err');
        }
      } catch { statusText(cgStatus, 'Erro ao adicionar.', 'err'); }
    }

    document.getElementById('cg_buscar').addEventListener('click', e=>{ e.preventDefault(); cgBuscarHandler(); });
    document.getElementById('cg_add').addEventListener('click', e=>{ e.preventDefault(); cgAddOrAlter(); });

    // =========================
    // COORDENADORES DE EQUIPE
    // =========================
    function buildTeamChooser(teamKey) {
      const card = makeEl(`
        <div class="card" id="coord_${idFromLabel(teamKey)}">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0;">${teamKey}</h3>
          </div>
          <div class="team-link" role="button">Abrir Visão de Equipes</div>
          <div class="status" id="st_${idFromLabel(teamKey)}"></div>
        </div>
      `);
      const link = card.querySelector('.team-link');
      link.addEventListener('click', ()=>{
        if (!anoSelecionado) { alert('Informe o ano antes.'); return; }
        const url = new URL('{{ url_for("visao_equipes") }}', window.location.origin);
        url.searchParams.set('equipe', teamKey);
        url.searchParams.set('target', teamKey);           // habilita links na visão
        url.searchParams.set('ano_montagem', String(anoSelecionado));
        window.location.href = url.toString();
      });
      return card;
    }

    function buildTeamEditor(teamKey, preset) {
      const idSafe = idFromLabel(teamKey);
      const equipeFinal = TEAM_MAP[teamKey] || teamKey;
      const card = makeEl(`
        <div class="card" id="coord_${idSafe}">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <h3 style="margin:0;">${teamKey}</h3>
            <div style="display:flex; gap:8px;">
              <button class="btn small" id="${idSafe}_btn_montar" style="display:none;">Montar Equipe</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="${idSafe}_ele">Nome (Ele)</label>
              <input id="${idSafe}_ele" placeholder="Ex.: João" value="${preset?.nome_ele || ''}">
            </div>
            <div>
              <label for="${idSafe}_ela">Nome (Ela)</label>
              <input id="${idSafe}_ela" placeholder="Ex.: Maria" value="${preset?.nome_ela || ''}">
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label for="${idSafe}_telefones">Telefones</label>
              <input id="${idSafe}_telefones" placeholder="Preenchido pela busca (editável)" value="${preset?.telefones || ''}">
            </div>
            <div>
              <label for="${idSafe}_endereco">Endereço</label>
              <input id="${idSafe}_endereco" placeholder="Preenchido pela busca (editável)" value="${preset?.endereco || ''}">
            </div>
          </div>

          <div class="row-3" style="margin-top:8px;">
            <button class="btn" id="${idSafe}_buscar">Buscar</button>
            <button class="btn primary" id="${idSafe}_add">Adicionar</button>
            <button class="btn" id="${idSafe}_alterar" style="display:none;">Alterar</button>
          </div>

          <div class="status" id="${idSafe}_status"></div>
        </div>
      `);

      const $ele = card.querySelector(`#${idSafe}_ele`);
      const $ela = card.querySelector(`#${idSafe}_ela`);
      const $tels = card.querySelector(`#${idSafe}_telefones`);
      const $end = card.querySelector(`#${idSafe}_endereco`);
      const $buscar = card.querySelector(`#${idSafe}_buscar`);
      const $add = card.querySelector(`#${idSafe}_add`);
      const $alterar = card.querySelector(`#${idSafe}_alterar`);
      const $status = card.querySelector(`#${idSafe}_status`);
      const $btnMontar = card.querySelector(`#${idSafe}_btn_montar`);

      let recId = preset?.id || null;

      function lockEditor(on) {
        [$ele,$ela,$tels,$end,$buscar].forEach(el=>setDisabled(el,on));
        $alterar.style.display = on ? '' : 'none';
        $add.style.display = on ? 'none' : '';
        $btnMontar.style.display = on ? '' : 'none';
      }

      async function buscar() {
        statusText($status,'','');
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        if (!nome_ele || !nome_ela) return statusText($status,'Preencha Nome (Ele) e Nome (Ela).','warn');

        try {
          const resp = await fetch('{{ url_for("api_buscar_casal") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ nome_ele, nome_ela })
          });
          const data = await resp.json();
          if (data.ok) {
            $tels.value = data.telefones || '';
            $end.value = data.endereco || '';
            statusText($status, `Dados carregados de ${data.origem}.`, 'ok');
          } else {
            statusText($status, data.msg || 'Não encontrado.', 'err');
          }
        } catch { statusText($status,'Erro ao buscar.','err'); }
      }

      async function adicionar() {
        statusText($status,'','');
        if (!anoSelecionado) return statusText($status,'Informe o ano antes.','warn');
        const nome_ele = ($ele.value||'').trim();
        const nome_ela = ($ela.value||'').trim();
        const telefones = ($tels.value||'').trim();
        const endereco = ($end.value||'').trim();
        if (!nome_ele || !nome_ela) return statusText($status,'Preencha Nome (Ele) e Nome (Ela).','warn');

        try {
          const resp = await fetch('{{ url_for("api_adicionar_dirigente") }}', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ano: anoSelecionado, equipe: equipeFinal, nome_ele, nome_ela, telefones, endereco })
          });
          const data = await resp.json();
          if (data.ok) {
            recId = data.id || recId;
            statusText($status,'Coordenador da equipe adicionado com sucesso.','ok');
            lockEditor(true);
          } else {
            statusText($status, data.msg || 'Falha ao adicionar.','err');
          }
        } catch { statusText($status,'Erro ao adicionar.','err'); }
      }

      function alterar() {
        if (!recId) return;
        card.querySelectorAll('.choice-box').forEach(n=>n.remove());
        const chooser = buildStatusChoice(async (choice, justificativa, boxEl)=>{
          try {
            const resp = await fetch('{{ url_for("api_marcar_status") }}', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ id: recId, status: choice, observacao: justificativa })
            });
            const data = await resp.json();
            if (data.ok) {
              statusText($status, `Status alterado para “${choice}”. Preencha novos dados e clique em Adicionar.`, 'ok');
              lockEditor(false);
              recId = null;
              $ele.value=''; $ela.value=''; $tels.value=''; $end.value='';
              boxEl.remove();
            } else {
              statusText($status, data.msg || 'Falha ao alterar.','err');
            }
          } catch { statusText($status,'Erro ao alterar.','err'); }
        });
        insertAfter($status, chooser);
      }

      $buscar.addEventListener('click', e=>{ e.preventDefault(); buscar(); });
      $add.addEventListener('click', e=>{ e.preventDefault(); adicionar(); });
      $alterar.addEventListener('click', e=>{ e.preventDefault(); alterar(); });

      $btnMontar.addEventListener('click', (e)=>{
        e.preventDefault();
        const url = new URL('{{ url_for("montagem_equipe") }}', window.location.origin);
        url.searchParams.set('ano', String(anoSelecionado));
        url.searchParams.set('equipe', teamKey);
        window.location.href = url.toString();
      });

      lockEditor(!!recId);
      return card;
    }

    function renderCoordsGrid() {
      coordsGrid.innerHTML = '';
      const teamKeys = Object.keys(TEAM_MAP);
      const presetVisao = initialData && initialData.preset_from_visao ? initialData.preset_from_visao : null;

      teamKeys.forEach(teamKey=>{
        let card;
        const preset = (initialData.coords && initialData.coords[teamKey]) ? initialData.coords[teamKey] : null;

        if (preset) {
          card = buildTeamEditor(teamKey, preset);
        } else if (presetVisao && presetVisao.target === teamKey) {
          card = buildTeamEditor(teamKey, {
            id: null,
            nome_ele: presetVisao.ele || '',
            nome_ela: presetVisao.ela || '',
            telefones: presetVisao.telefones || '',
            endereco: presetVisao.endereco || ''
          });
        } else {
          card = buildTeamChooser(teamKey);
        }

        coordsGrid.appendChild(card);
      });
    }

    // =========================
    // Concluir Montagem do Ano
    // =========================
    function showConcluirAnoIfReady() { show(btnConcluirAno, !!anoSelecionado); }
    btnConcluirAno.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!anoSelecionado) return;
      if (!confirm(`Concluir a montagem do ano ${anoSelecionado}? Todos os registros 'Aberto' serão marcados como 'Concluido'.`)) return;
      try {
        const resp = await fetch('{{ url_for("api_concluir_montagem_ano") }}', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ano: anoSelecionado })
        });
        const data = await resp.json();
        if (data.ok) {
          alert(`Montagem ${anoSelecionado} concluída. Registros atualizados: ${data.updated}.`);
          window.location.href = '{{ url_for("montagem") }}';
        } else {
          alert(data.msg || 'Falha ao concluir montagem.');
        }
      } catch { alert('Erro ao concluir montagem.'); }
    });

    // =========================
    // Fluxo principal
    // =========================
    function renderDirigentesEcg() {
      renderDirigentes();
      show(cgCard, true);
      renderCGPresetIfAny();
      maybeEnableCG();
      if (cgAdded) {
        show(coordsSection, true);
        renderCoordsGrid();
      } else {
        show(coordsSection, false);
      }
    }

    btnContinuar.addEventListener('click', (e)=>{
      e.preventDefault();
      const val = (anoInput.value||'').trim();
      if (!/^\d{4}$/.test(val)) {
        statusText(anoMsg, 'Informe um ano válido (YYYY).', 'err');
        return;
      }
      anoSelecionado = parseInt(val,10);
      statusText(anoMsg, `Ano selecionado: ${anoSelecionado}`, 'ok');

      totalDirigentesAdicionados = 0;
      kpiDone.textContent = '0';

      renderDirigentesEcg();
      showConcluirAnoIfReady();
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      if (anoPre) { btnContinuar.click(); }
      const notfound = {{ (request.args.get('notfound') or '0') | tojson }};
      if (notfound === '1') { alert('Não foi possível carregar o casal selecionado.'); }
    });
  </script>
</body>
</html>


