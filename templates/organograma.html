<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Organograma ECC</title>
  <script src="https://unpkg.com/gojs/release/go-debug.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    #ano { font-size: 16px; margin-bottom: 20px; }
    #myDiagramDiv {
      width: 100%;
      height: 1400px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Organograma ECC</h2>
  <label for="ano">Ano:</label>
  <select id="ano" onchange="carregarOrganograma()">
    {% for a in range(2024, 1999, -1) %}
      <option value="{{ a }}">{{ a }}</option>
    {% endfor %}
  </select>

  <div id="myDiagramDiv"></div>

  <script>
    const $ = go.GraphObject.make;
    let diagram;

    function initDiagram() {
      diagram = $(go.Diagram, "myDiagramDiv", {
        layout: $(go.Layout),
        initialContentAlignment: go.Spot.TopLeft,
        isReadOnly: true,
        "grid.visible": false,
        "animationManager.isEnabled": false
      });

      diagram.nodeTemplate =
        $(go.Node, "Auto",
          new go.Binding("location", "loc", go.Point.parse),
          $(go.Shape, "RoundedRectangle",
            {
              fill: "#CFE2F3", stroke: "#999", strokeWidth: 1.5, width: 250, height: 100
            },
            new go.Binding("fill", "isCoord", v => v ? "#FFE599" : "#CFE2F3")
          ),
          $(go.Panel, "Vertical",
            $(go.TextBlock, { margin: 4, font: "bold 13px sans-serif", wrap: go.TextBlock.WrapFit, width: 230 },
              new go.Binding("text", "equipe")),
            $(go.TextBlock, { font: "italic 11px sans-serif", stroke: "#333" },
              new go.Binding("text", "isCoord", v => v ? "Coordenador" : "")),
            $(go.TextBlock, { margin: 4, font: "12px sans-serif", wrap: go.TextBlock.WrapFit, width: 230 },
              new go.Binding("text", "casal"))
          )
        );
    }

    function carregarOrganograma() {
      const ano = document.getElementById("ano").value;
      fetch(`/dados-organograma?ano=${ano}`)
        .then(res => res.json())
        .then(data => montarOrganograma(data));
    }

    function montarOrganograma(data) {
      const posicoes = {
        "Dirigentes": [50, 50],
        "Coordenador Geral": [500, 50],
        "Casal Setorial": [950, 50],
        "Sala": [100, 300],
        "Círculos": [900, 300],
        "Café e Minimercado": [0, 550],
        "Compras": [300, 550],
        "Acolhida": [600, 550],
        "Ordem e Limpeza": [900, 550],
        "Liturgia e Vigília": [1200, 550],
        "Secretaria": [1500, 550],
        "Cozinha": [1800, 550],
        "Visitação": [2100, 550]
      };

      const nodes = [];
      const counters = {};

      // Agrupar por equipe e ordenar com coordenadores primeiro
      const grupos = {};
      for (const p of data) {
        const equipe = (p.equipe || "").trim();
        if (!grupos[equipe]) grupos[equipe] = [];
        grupos[equipe].push(p);
      }

      for (const equipe in grupos) {
        const lista = grupos[equipe];
        // Coordenadores primeiro
        lista.sort((a, b) => {
          const ca = (a.coordenador || "").toLowerCase().trim() === "sim" ? -1 : 1;
          const cb = (b.coordenador || "").toLowerCase().trim() === "sim" ? -1 : 1;
          return ca - cb;
        });

        const nomeExibicao = Object.keys(posicoes).find(k => equipe.toUpperCase().includes(k.toUpperCase())) || "Outros";
        if (!counters[nomeExibicao]) counters[nomeExibicao] = 0;
        const [baseX, baseY] = posicoes[nomeExibicao] || [0, 1000];

        for (const p of lista) {
          const nome = `${p.nome_ele} e ${p.nome_ela}`;
          const isCoord = (p.coordenador || "").toLowerCase().trim() === "sim";
          const spacing = 110;
          const yOffset = counters[nomeExibicao]++ * spacing;

          nodes.push({
            key: `${equipe}_${nome}`,
            equipe: equipe,
            casal: nome,
            isCoord: isCoord,
            loc: `${baseX} ${baseY + yOffset}`
          });
        }
      }

      diagram.model = new go.GraphLinksModel(nodes);
    }

    window.addEventListener("load", () => {
      initDiagram();
      document.getElementById("ano").value = "2024";
      carregarOrganograma();
    });
  </script>
</body>
</html>
