<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Organograma ECC</title>
  <script src="https://unpkg.com/gojs/release/go-debug.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    #ano { font-size: 16px; margin-bottom: 20px; }
    #myDiagramDiv {
      width: 100%;
      height: 1200px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Organograma ECC</h2>
  <label for="ano">Ano:</label>
  <select id="ano" onchange="carregarOrganograma()">
    {% for a in range(2024, 1999, -1) %}
      <option value="{{ a }}">{{ a }}</option>
    {% endfor %}
  </select>

  <div id="myDiagramDiv"></div>

  <script>
    const $ = go.GraphObject.make;
    let diagram;

    function initDiagram() {
      diagram = $(go.Diagram, "myDiagramDiv", {
        layout: $(go.Layout),
        initialContentAlignment: go.Spot.TopLeft,
        isReadOnly: true
      });

      diagram.nodeTemplate =
        $(go.Node, "Auto",
          $(go.Shape, "RoundedRectangle",
            {
              fill: "#CFE2F3", stroke: "#999", strokeWidth: 1.5, width: 250, height: 100
            },
            new go.Binding("fill", "isCoord", v => v ? "#FFE599" : "#CFE2F3")
          ),
          $(go.Panel, "Vertical",
            $(go.TextBlock, { margin: 4, font: "bold 13px sans-serif", wrap: go.TextBlock.WrapFit, width: 230 },
              new go.Binding("text", "equipe")),
            $(go.TextBlock, { font: "italic 11px sans-serif", stroke: "#333" },
              new go.Binding("text", "isCoord", v => v ? "Coordenador" : "")),
            $(go.TextBlock, { margin: 4, font: "12px sans-serif", wrap: go.TextBlock.WrapFit, width: 230 },
              new go.Binding("text", "casal"))
          )
        );
    }

    function carregarOrganograma() {
      const ano = document.getElementById("ano").value;
      fetch(`/dados-organograma?ano=${ano}`)
        .then(res => res.json())
        .then(data => montarOrganograma(data));
    }

    function montarOrganograma(data) {
      const posicoes = {
        "Dirigentes": [50, 50],
        "Coordenador Geral": [400, 50],
        "Casal Setorial": [800, 50],
        "Sala": [150, 250],
        "Círculos": [700, 250],
        "Café e Minimercado": [0, 450],
        "Compras": [300, 450],
        "Acolhida": [600, 450],
        "Ordem e Limpeza": [900, 450],
        "Liturgia e Vigília": [1200, 450],
        "Secretaria": [1500, 450],
        "Cozinha": [1800, 450],
        "Visitação": [2100, 450]
      };

      const nodes = [];
      const counters = {};

      for (const p of data) {
        const equipe = (p.equipe || "").trim();
        const nome = `${p.nome_ele} e ${p.nome_ela}`;
        const isCoord = (p.coordenador || "").toLowerCase().trim() === "sim";

        // agrupar por equipe visual
        let key = Object.keys(posicoes).find(k => equipe.toUpperCase().includes(k.toUpperCase()));
        if (!key) key = "Outros";

        if (!counters[key]) counters[key] = 0;
        const [baseX, baseY] = posicoes[key] || [0, 800];
        const spacing = 110;
        const yOffset = counters[key]++ * spacing;

        nodes.push({
          key: `${equipe}_${nome}`,
          equipe: equipe,
          casal: nome,
          isCoord: isCoord,
          category: "",
          loc: `${baseX} ${baseY + yOffset}`
        });
      }

      diagram.model = new go.GraphLinksModel(nodes);
      diagram.model.nodeDataArray.forEach(n => {
        diagram.findNodeForData(n).location = go.Point.parse(n.loc);
      });
    }

    window.addEventListener("load", () => {
      initDiagram();
      document.getElementById("ano").value = "2024";
      carregarOrganograma();
    });
  </script>
</body>
</html>
