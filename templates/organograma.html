<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Organograma ECC</title>

    <!-- GoJS CDN -->
    <script src="https://unpkg.com/gojs/release/go-debug.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        select {
            padding: 5px;
            font-size: 16px;
        }

        #myDiagramDiv {
            width: 100%;
            height: 700px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Organograma ECC</h1>

    <label for="ano">Selecione o ano:</label>
    <select id="ano" onchange="carregarOrganograma()">
        {% for a in range(2024, 1999, -1) %}
            <option value="{{ a }}">{{ a }}</option>
        {% endfor %}
    </select>

    <div id="myDiagramDiv"></div>

    <script>
        async function carregarOrganograma() {
            const ano = document.getElementById("ano").value;
            const resposta = await fetch(`/dados-organograma?ano=${ano}`);
            const dados = await resposta.json();
            criarOrganograma(dados);
        }

        function criarOrganograma(dados) {
            const $ = go.GraphObject.make;

            const diagram = $(go.Diagram, "myDiagramDiv", {
                initialAutoScale: go.Diagram.Uniform,
                layout: $(go.TreeLayout, {
                    angle: 90,
                    layerSpacing: 40
                }),
                "undoManager.isEnabled": true
            });

            // Estilo dos nós
            diagram.nodeTemplate =
                $(go.Node, "Auto",
                    $(go.Shape, "RoundedRectangle",
                        {
                            fill: "lightblue",
                            stroke: "#555",
                            strokeWidth: 1.5
                        },
                        new go.Binding("fill", "isCoordinator", c => c ? "#ffcc00" : "lightblue")
                    ),
                    $(go.TextBlock,
                        {
                            margin: 8,
                            font: "bold 13px sans-serif",
                            wrap: go.TextBlock.WrapFit,
                            width: 180
                        },
                        new go.Binding("text", "label"))
                );

            // Dados do modelo
            const nodes = [];
            const links = [];
            const equipes = {};

            for (const pessoa of dados) {
                const nome = `${pessoa.nome_ele} e ${pessoa.nome_ela}`;
                const id = `${pessoa.equipe}_${nome}`;
                const isCoord = pessoa.coordenador.trim().toLowerCase() === "sim";
                const label = isCoord ? `⭐ ${nome}` : nome;

                // Adiciona nó da equipe se ainda não existir
                if (!equipes[pessoa.equipe]) {
                    const equipeId = `equipe_${pessoa.equipe}`;
                    equipes[pessoa.equipe] = equipeId;
                    nodes.push({ key: equipeId, label: pessoa.equipe });
                }

                nodes.push({
                    key: id,
                    label: label,
                    isCoordinator: isCoord
                });

                links.push({
                    from: equipes[pessoa.equipe],
                    to: id
                });
            }

            diagram.model = new go.GraphLinksModel(nodes, links);
        }

        // Carrega o ano atual automaticamente ao abrir a página
        window.onload = () => {
            document.getElementById("ano").value = "2024";
            carregarOrganograma();
        };
    </script>
</body>
</html>
