<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Organograma ECC</title>
    <script src="https://unpkg.com/gojs/release/go-debug.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        select {
            padding: 5px;
            font-size: 16px;
        }
        #myDiagramDiv {
            width: 100%;
            height: 1000px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Organograma ECC</h1>
    <label for="ano">Selecione o ano:</label>
    <select id="ano" onchange="carregarOrganograma()">
        {% for a in range(2024, 1999, -1) %}
            <option value="{{ a }}">{{ a }}</option>
        {% endfor %}
    </select>

    <div id="myDiagramDiv"></div>

    <script>
        async function carregarOrganograma() {
            const ano = document.getElementById("ano").value;
            const resposta = await fetch(`/dados-organograma?ano=${ano}`);
            const dados = await resposta.json();
            desenharOrganograma(dados);
        }

        function desenharOrganograma(dados) {
            const $ = go.GraphObject.make;

            const diagram = $(go.Diagram, "myDiagramDiv", {
                layout: $(go.LayeredDigraphLayout, {
                    direction: 90,  // vertical
                    layerSpacing: 50,
                    columnSpacing: 30
                }),
                initialAutoScale: go.Diagram.Uniform,
                isReadOnly: true,
                "undoManager.isEnabled": false
            });

            diagram.nodeTemplate = $(
                go.Node, "Auto",
                $(go.Shape, "RoundedRectangle",
                    {
                        fill: "lightblue",
                        strokeWidth: 1.5
                    },
                    new go.Binding("fill", "cor")
                ),
                $(go.Panel, "Vertical",
                    { margin: 6 },
                    $(go.TextBlock,
                        { font: "bold 13px sans-serif", stroke: "#333" },
                        new go.Binding("text", "titulo")),
                    $(go.TextBlock,
                        { font: "12px sans-serif", stroke: "#000" },
                        new go.Binding("text", "casal"))
                )
            );

            const equipesFixas = [
                { key: "dirigentes", titulo: "Dirigentes", loc: "0 0" },
                { key: "coordenador_geral", titulo: "Coordenador Geral", loc: "150 0" },
                { key: "setorial", titulo: "Casal Setorial", loc: "300 0" },
                { key: "sala", titulo: "Sala", loc: "0 200" },
                { key: "circulos", titulo: "Círculos", loc: "300 200" },
                { key: "cafe", titulo: "Café e Minimercado", loc: "0 400" },
                { key: "compras", titulo: "Compras", loc: "100 400" },
                { key: "acolhida", titulo: "Acolhida", loc: "200 400" },
                { key: "ordem", titulo: "Ordem e Limpeza", loc: "300 400" },
                { key: "liturgia", titulo: "Liturgia e Vigília", loc: "400 400" },
                { key: "secretaria", titulo: "Secretaria", loc: "500 400" },
                { key: "cozinha", titulo: "Cozinha", loc: "600 400" },
                { key: "visitacao", titulo: "Visitação", loc: "700 400" }
            ];

            const nodes = [];
            const links = [];

            // Nós fixos principais
            for (const eq of equipesFixas) {
                nodes.push({
                    key: eq.key,
                    titulo: eq.titulo,
                    casal: "",
                    cor: "#e0e0e0"
                });
            }

            // Preencher casais
            for (const p of dados) {
                const nome = `${p.nome_ele} e ${p.nome_ela}`;
                const equipeRaw = p.equipe.toLowerCase();

                let chavePai = "";
                let titulo = "";
                let cor = "lightblue";

                const coordenador = p.coordenador?.trim().toLowerCase() === "sim";

                if (equipeRaw.includes("coordenador geral")) {
                    chavePai = "coordenador_geral";
                    titulo = "Coordenador Geral";
                } else if (equipeRaw.includes("setorial")) {
                    chavePai = "setorial";
                    titulo = "Casal Setorial";
                } else if (equipeRaw.includes("dirigente")) {
                    chavePai = "dirigentes";
                    titulo = p.equipe.split("-")[1]?.trim() || "Dirigente";
                } else if (equipeRaw.includes("sala")) {
                    chavePai = "sala";
                    titulo = p.equipe.split("-")[1]?.trim() || "Sala";
                } else if (equipeRaw.includes("círculos") || equipeRaw.includes("circulos")) {
                    chavePai = "circulos";
                    titulo = "Círculos";
                } else if (equipeRaw.includes("café")) {
                    chavePai = "cafe";
                    titulo = "Café e Minimercado";
                } else if (equipeRaw.includes("compra")) {
                    chavePai = "compras";
                    titulo = "Compras";
                } else if (equipeRaw.includes("acolhida")) {
                    chavePai = "acolhida";
                    titulo = "Acolhida";
                } else if (equipeRaw.includes("ordem")) {
                    chavePai = "ordem";
                    titulo = "Ordem e Limpeza";
                } else if (equipeRaw.includes("liturgia")) {
                    chavePai = "liturgia";
                    titulo = "Liturgia e Vigília";
                } else if (equipeRaw.includes("secretaria")) {
                    chavePai = "secretaria";
                    titulo = "Secretaria";
                } else if (equipeRaw.includes("cozinha")) {
                    chavePai = "cozinha";
                    titulo = "Cozinha";
                } else if (equipeRaw.includes("visitação") || equipeRaw.includes("visitacao")) {
                    chavePai = "visitacao";
                    titulo = "Visitação";
                }

                const key = `${chavePai}_${nome}`;
                const labelTitulo = coordenador ? `${titulo}\nCoordenador` : titulo;

                nodes.push({
                    key: key,
                    titulo: labelTitulo,
                    casal: nome,
                    cor: coordenador ? "#ffe066" : "lightblue"
                });

                links.push({ from: chavePai, to: key });
            }

            diagram.model = new go.GraphLinksModel(nodes, links);
        }

        window.onload = () => {
            document.getElementById("ano").value = "2024";
            carregarOrganograma();
        };
    </script>
</body>
</html>
