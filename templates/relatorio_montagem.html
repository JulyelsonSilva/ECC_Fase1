{% extends "_print_base.html" %}
{% block content %}
{% set _title = "Relatório de Montagem • " ~ ano %}
{% set title = _title %}

<h2>Relatório de Montagem • {{ ano }}</h2>
<p class="muted">Coordenadores destacados. Nomes em maiúsculo. Ao final: “Desistiu/Recusou” por equipe com motivo.</p>

{# ===== Helpers ===== #}
{% macro fmt_nome(r) -%}
  {{ (r.nome_ele or r.ele or '')|upper }} &amp; {{ (r.nome_ela or r.ela or '')|upper }}
{%- endmacro %}

{% macro badge_subfunc(r) -%}
  {% if r.equipe and '-' in r.equipe %}
    <span class="badge muted" style="margin-left:6pt">{{ r.equipe.split('-', 1)[1].strip() }}</span>
  {% endif %}
{%- endmacro %}

{# Normaliza qualquer texto de equipe para um título canônico da ordem fixa #}
{% macro group_key(eq_raw) -%}
  {% set E = (eq_raw or '')|upper %}
  {% if 'CASAL COORDENADOR GERAL' in E %}
    {{ 'Casal Coordenador Geral' }}
  {% elif 'DIRIGENTE' in E %}
    {{ 'Equipe Dirigente' }}
  {% elif 'SALA' in E %}
    {{ 'Equipe Sala' }}
  {% elif 'CÍRC' in E or 'CIRC' in E %}
    {{ 'Equipe Círculos' }}
  {% elif ('CAFÉ' in E or 'CAFE' in E) and 'MINI' in E %}
    {{ 'Equipe Café e Minimercado' }}
  {% elif 'COMPRAS' in E %}
    {{ 'Equipe Compras' }}
  {% elif 'ACOLHIDA' in E %}
    {{ 'Equipe Acolhida' }}
  {% elif 'ORDEM' in E and 'LIMPEZA' in E %}
    {{ 'Equipe Ordem e Limpeza' }}
  {% elif 'LITURGIA' in E or 'VIGIL' in E %}
    {{ 'Equipe Liturgia e Vigilia' }}
  {% elif 'SECRETARIA' in E %}
    {{ 'Equipe Secretaria' }}
  {% elif 'COZINHA' in E %}
    {{ 'Equipe Cozinha' }}
  {% elif 'VISITA' in E %}
    {{ 'Equipe Visitação' }}
  {% else %}
    {{ '' }}
  {% endif %}
{%- endmacro %}

{# Bloco de equipe (coordenadores primeiro), ignorando Desistiu/Recusou #}
{% macro render_bloco(titulo, lista) -%}
  {% if lista|length %}
    <h3 style="margin:12pt 0 6pt; font-size:12.5pt;">{{ titulo }}</h3>
    <table>
      <thead><tr><th>Casal</th><th>Telefone(s)</th><th>Endereço</th></tr></thead>
      <tbody>
        {# Coordenadores #}
        {% for r in lista
             if (r.is_coord or ((r.coordenador is defined) and (r.coordenador|string|trim|lower == 'sim')))
             and ((r.status or '')|trim|lower not in ['desistiu','recusou']) %}
          <tr>
            <td><span class="badge">Coordenador</span> {{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
            <td>{{ r.telefones or '' }}</td>
            <td>{{ r.endereco or '' }}</td>
          </tr>
        {% endfor %}
        {# Demais #}
        {% for r in lista
             if not (r.is_coord or ((r.coordenador is defined) and (r.coordenador|string|trim|lower == 'sim')))
             and ((r.status or '')|trim|lower not in ['desistiu','recusou']) %}
          <tr>
            <td>{{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
            <td>{{ r.telefones or '' }}</td>
            <td>{{ r.endereco or '' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{%- endmacro %}

{# ===== Ordem fixa ===== #}
{% set ORDEM = [
  'Equipe Dirigente',
  'Casal Coordenador Geral',
  'Equipe Sala',
  'Equipe Círculos',
  'Equipe Café e Minimercado',
  'Equipe Compras',
  'Equipe Acolhida',
  'Equipe Ordem e Limpeza',
  'Equipe Liturgia e Vigilia',
  'Equipe Secretaria',
  'Equipe Cozinha',
  'Equipe Visitação'
] %}

{# ===== Buckets principais e de pendências usando a MESMA chave canônica ===== #}
{% set grupos = dict() %}
{% set pend   = dict() %}

{% for key in ORDEM %}
  {% if grupos.update({key: []}) %}{% endif %}
  {% if pend.update({key: []}) %}{% endif %}
{% endfor %}

{% for r in rows %}
  {% set key = group_key(r.equipe) %}
  {% if key %}
    {% set status_norm = (r.status or '')|trim|lower %}
    {% if status_norm in ['desistiu','recusou'] %}
      {% set lst = pend.get(key) + [r] %}
      {% if pend.update({key: lst}) %}{% endif %}
    {% else %}
      {% set lst = grupos.get(key) + [r] %}
      {% if grupos.update({key: lst}) %}{% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{# ===== Parte 1: Equipes montadas ===== #}
{% for titulo in ORDEM %}
  {{ render_bloco(titulo, grupos.get(titulo)) }}
{% endfor %}

{# ===== Parte 2: Apêndice — Desistiu/Recusou (com motivo) ===== #}
{% set tem_pend = false %}
{% for titulo in ORDEM %}
  {% if pend.get(titulo)|length %}{% set tem_pend = true %}{% endif %}
{% endfor %}

{% if tem_pend %}
  <hr style="margin:16pt 0; border:none; border-top:1px solid #e5e7eb;">
  <h2 style="margin:0 0 8pt;">Desistências e Recusas</h2>
  <p class="muted" style="margin:0 0 10pt;">Listagem por equipe com status e motivo informado.</p>

  {% for titulo in ORDEM %}
    {% set lista = pend.get(titulo) %}
    {% if lista and (lista|length) %}
      <h3 style="margin:10pt 0 6pt; font-size:12.5pt;">{{ titulo }}</h3>
      <table>
        <thead><tr><th>Casal</th><th>Status</th><th>Motivo (Observação)</th></tr></thead>
        <tbody>
          {% for r in lista %}
            {% set st = (r.status or '')|trim|lower %}
            <tr>
              <td>{{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
              <td>
                {% if st == 'recusou' %}
                  <span class="badge" style="background:#fee2e2; border-color:#fecaca; color:#991b1b;">RECUSOU</span>
                {% elif st == 'desistiu' %}
                  <span class="badge" style="background:#fffbeb; border-color:#fef3c7; color:#92400e;">DESISTIU</span>
                {% else %}
                  {{ r.status or '' }}
                {% endif %}
              </td>
              <td>{{ r.observacao or '—' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  {% endfor %}
{% else %}
  <p class="muted" style="margin-top:12pt;">Sem registros de Desistiu/Recusou.</p>
{% endif %}

{% if not rows or rows|length == 0 %}
  <p class="muted">Nenhum integrante encontrado para {{ ano }}.</p>
{% endif %}
{% endblock %}