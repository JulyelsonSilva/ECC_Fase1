{% extends "_print_base.html" %}
{% block content %}
{% set _title = "Relatório de Montagem • " ~ ano %}
{% set title = _title %}

<h2>Relatório de Montagem • {{ ano }}</h2>
<p class="muted">Coordenadores destacados. Nomes em maiúsculo. Ao final: “Desistiu/Recusou” por equipe com motivo.</p>

{# ========== Helpers simples ========== #}
{% macro fmt_nome(r) -%}
  {{ (r.nome_ele or r.ele or '')|upper }} &amp; {{ (r.nome_ela or r.ela or '')|upper }}
{%- endmacro %}

{% macro badge_subfunc(r) -%}
  {% if r.equipe and '-' in r.equipe %}
    <span class="badge muted" style="margin-left:6pt">{{ r.equipe.split('-', 1)[1].strip() }}</span>
  {% endif %}
{%- endmacro %}

{% macro status_norm(s) -%}
  {{ (s or '')|trim|lower }}
{%- endmacro %}

{# Bloco de equipe (coordenadores primeiro), ignorando Desistiu/Recusou #}
{% macro render_bloco(titulo, lista) -%}
  {% if lista and (lista|length) %}
    <h3 style="margin:12pt 0 6pt; font-size:12.5pt;">{{ titulo }}</h3>
    <table>
      <thead>
        <tr>
          <th>Casal</th>
          <th>Ano do Encontro</th>
          <th>Telefone(s)</th>
          <th>Endereço</th>
        </tr>
      </thead>
      <tbody>
        {# Coordenadores primeiro (exclui Desistiu/Recusou) #}
        {% for r in lista
             if (status_norm(r.status) not in ['desistiu','recusou'])
             and (r.is_coord
                  or ((r.coordenador is defined) and (r.coordenador|string|trim|lower == 'sim'))) %}
          <tr>
            <td><span class="badge">Coordenador</span> {{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
            <td>{{ r.ano_encontro if r.ano_encontro is not none else '—' }}</td>
            <td>{{ r.telefones or '' }}</td>
            <td>{{ r.endereco or '' }}</td>
          </tr>
        {% endfor %}

        {# Demais (exclui Desistiu/Recusou) #}
        {% for r in lista
             if (status_norm(r.status) not in ['desistiu','recusou'])
             and not (r.is_coord
                      or ((r.coordenador is defined) and (r.coordenador|string|trim|lower == 'sim'))) %}
          <tr>
            <td>{{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
            <td>{{ r.ano_encontro if r.ano_encontro is not none else '—' }}</td>
            <td>{{ r.telefones or '' }}</td>
            <td>{{ r.endereco or '' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{%- endmacro %}

{# ========== Buckets com namespace (sem dict.update) ========== #}
{% set up = namespace(
  dirigente = [], cg = [], sala = [], circulos = [], cafe = [],
  compras = [], acolhida = [], ordem = [], liturgia = [],
  secretaria = [], cozinha = [], visitacao = []
) %}

{% set pend = namespace(
  dirigente = [], cg = [], sala = [], circulos = [], cafe = [],
  compras = [], acolhida = [], ordem = [], liturgia = [],
  secretaria = [], cozinha = [], visitacao = []
) %}

{# Classifica uma linha em um dos grupos, incluindo variações de texto #}
{% for r in rows %}
  {% set E = (r.equipe or '')|upper %}
  {% set st = status_norm(r.status) %}

  {% if 'CASAL COORDENADOR GERAL' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.cg.append(r) %}{% else %}{% set _ = up.cg.append(r) %}{% endif %}
  {% elif 'DIRIGENTE' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.dirigente.append(r) %}{% else %}{% set _ = up.dirigente.append(r) %}{% endif %}
  {% elif 'SALA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.sala.append(r) %}{% else %}{% set _ = up.sala.append(r) %}{% endif %}
  {% elif 'CÍRC' in E or 'CIRC' in E %}
    {# cobre "EQUIPE DE CIRCULOS", "CÍRCULOS", etc. #}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.circulos.append(r) %}{% else %}{% set _ = up.circulos.append(r) %}{% endif %}
  {% elif ('CAFÉ' in E or 'CAFE' in E) and 'MINI' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.cafe.append(r) %}{% else %}{% set _ = up.cafe.append(r) %}{% endif %}
  {% elif 'COMPRAS' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.compras.append(r) %}{% else %}{% set _ = up.compras.append(r) %}{% endif %}
  {% elif 'ACOLHIDA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.acolhida.append(r) %}{% else %}{% set _ = up.acolhida.append(r) %}{% endif %}
  {% elif 'ORDEM' in E and 'LIMPEZA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.ordem.append(r) %}{% else %}{% set _ = up.ordem.append(r) %}{% endif %}
  {% elif 'LITURGIA' in E or 'VIGIL' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.liturgia.append(r) %}{% else %}{% set _ = up.liturgia.append(r) %}{% endif %}
  {% elif 'SECRETARIA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.secretaria.append(r) %}{% else %}{% set _ = up.secretaria.append(r) %}{% endif %}
  {% elif 'COZINHA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.cozinha.append(r) %}{% else %}{% set _ = up.cozinha.append(r) %}{% endif %}
  {% elif 'VISITA' in E %}
    {% if st in ['desistiu','recusou'] %}{% set _ = pend.visitacao.append(r) %}{% else %}{% set _ = up.visitacao.append(r) %}{% endif %}
  {% endif %}
{% endfor %}

{# ========== Ordem fixa (mesma usada antes) ========== #}
{{ render_bloco('Equipe Dirigente', up.dirigente) }}
{{ render_bloco('Casal Coordenador Geral', up.cg) }}
{{ render_bloco('Equipe Sala', up.sala) }}
{{ render_bloco('Equipe Círculos', up.circulos) }}
{{ render_bloco('Equipe Café e Minimercado', up.cafe) }}
{{ render_bloco('Equipe Compras', up.compras) }}
{{ render_bloco('Equipe Acolhida', up.acolhida) }}
{{ render_bloco('Equipe Ordem e Limpeza', up.ordem) }}
{{ render_bloco('Equipe Liturgia e Vigilia', up.liturgia) }}
{{ render_bloco('Equipe Secretaria', up.secretaria) }}
{{ render_bloco('Equipe Cozinha', up.cozinha) }}
{{ render_bloco('Equipe Visitação', up.visitacao) }}

{# ========== Apêndice: Desistiu/Recusou (com motivo), por equipe ========== #}
{% set tem_pend = (
  pend.dirigente|length or pend.cg|length or pend.sala|length or pend.circulos|length or
  pend.cafe|length or pend.compras|length or pend.acolhida|length or pend.ordem|length or
  pend.liturgia|length or pend.secretaria|length or pend.cozinha|length or pend.visitacao|length
) %}

{% if tem_pend %}
  <hr style="margin:16pt 0; border:none; border-top:1px solid #e5e7eb;">
  <h2 style="margin:0 0 8pt;">Desistências e Recusas</h2>
  <p class="muted" style="margin:0 0 10pt;">Listagem por equipe com status e motivo informado.</p>

  {% macro bloco_pend(titulo, lista) -%}
    {% if lista and (lista|length) %}
      <h3 style="margin:10pt 0 6pt; font-size:12.5pt;">{{ titulo }}</h3>
      <table>
        <thead>
          <tr>
            <th>Casal</th>
            <th>Ano do Encontro</th>
            <th>Status</th>
            <th>Motivo (Observação)</th>
          </tr>
        </thead>
        <tbody>
          {% for r in lista %}
            {% set st = status_norm(r.status) %}
            <tr>
              <td>{{ fmt_nome(r) }} {{ badge_subfunc(r) }}</td>
              <td>{{ r.ano_encontro if r.ano_encontro is not none else '—' }}</td>
              <td>
                {% if st == 'recusou' %}
                  <span class="badge" style="background:#fee2e2; border-color:#fecaca; color:#991b1b;">RECUSOU</span>
                {% elif st == 'desistiu' %}
                  <span class="badge" style="background:#fffbeb; border-color:#fef3c7; color:#92400e;">DESISTIU</span>
                {% else %}
                  {{ r.status or '' }}
                {% endif %}
              </td>
              <td>{{ r.observacao or '—' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  {%- endmacro %}

  {{ bloco_pend('Equipe Dirigente', pend.dirigente) }}
  {{ bloco_pend('Casal Coordenador Geral', pend.cg) }}
  {{ bloco_pend('Equipe Sala', pend.sala) }}
  {{ bloco_pend('Equipe Círculos', pend.circulos) }}
  {{ bloco_pend('Equipe Café e Minimercado', pend.cafe) }}
  {{ bloco_pend('Equipe Compras', pend.compras) }}
  {{ bloco_pend('Equipe Acolhida', pend.acolhida) }}
  {{ bloco_pend('Equipe Ordem e Limpeza', pend.ordem) }}
  {{ bloco_pend('Equipe Liturgia e Vigilia', pend.liturgia) }}
  {{ bloco_pend('Equipe Secretaria', pend.secretaria) }}
  {{ bloco_pend('Equipe Cozinha', pend.cozinha) }}
  {{ bloco_pend('Equipe Visitação', pend.visitacao) }}
{% else %}
  <p class="muted" style="margin-top:12pt;">Sem registros de Desistiu/Recusou.</p>
{% endif %}

{% if not rows or rows|length == 0 %}
  <p class="muted">Nenhum integrante encontrado para {{ ano }}.</p>
{% endif %}
{% endblock %}