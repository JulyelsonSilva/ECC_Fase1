<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Relat√≥rios ‚Ä¢ ECC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb;
      --brand:#2563eb; --brand-600:#1e40af; --brand-50:#eff6ff; --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
      background:
        radial-gradient(1200px 800px at 80% -10%, #e0ebff 0%, rgba(224,235,255,0) 60%),
        radial-gradient(1000px 600px at -10% 110%, #fff3d6 0%, rgba(255,243,214,0) 60%),
        var(--bg);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 64px;}
    header{
      display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap; padding:12px 0 8px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:54px; height:54px; border-radius:50%; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--brand), var(--brand-600));
      color:white; font-size:28px; box-shadow: 0 8px 24px rgba(37,99,235,.25);
    }
    .titles h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .titles p{ margin:2px 0 0; color:var(--muted); font-size:13px; }
    .stamp{
      display:flex; align-items:center; gap:10px; color:#334155; font-size:13px;
      background: var(--brand-50); border:1px solid #dbeafe; padding:8px 12px; border-radius:999px;
    }
    .stamp .dot{
      width:10px; height:10px; border-radius:999px; background: var(--accent);
      box-shadow: 0 0 0 4px rgba(245,158,11,.15);
    }

    .hero{
      margin:18px 0 8px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      box-shadow: 0 8px 20px rgba(15,23,42,.05);
    }
    .hero .text h2{ margin:0 0 6px; font-size:20px; }
    .hero .text p{ margin:0; color:var(--muted); font-size:14px; }
    .hero .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      text-decoration:none; background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px; border:1px solid var(--brand-600);
    }
    select{
      padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#fff;
    }

    /* Pilha vertical: DONUT em cima; duas barras embaixo */
    .stack{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:18px; }
    .chart-card{
      background:#fff; border:1px solid var(--border); border-radius:16px; padding:12px;
      min-height:340px; position:relative;
    }
    .chart-card canvas{ height: 100%; width: 100%; }
    .msg{
      position:absolute; inset:0; display:grid; place-items:center;
      color:var(--muted); font-size:14px; padding:12px; text-align:center;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --card:#0f172a; --border:#1e293b; --ink:#e2e8f0; --muted:#94a3b8;
        --brand:#3b82f6; --brand-600:#1d4ed8; --brand-50:#0b255a; --accent:#fde68a;
      }
      .logo, .hero{ box-shadow:none; }
      body{
        background:
          radial-gradient(1200px 800px at 80% -10%, rgba(30,64,175,.25) 0%, rgba(30,64,175,0) 55%),
          radial-gradient(1000px 600px at -10% 110%, rgba(245,158,11,.15) 0%, rgba(245,158,11,0) 55%),
          var(--bg);
      }
      .chart-card{ background:var(--card); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üïäÔ∏è</div>
        <div class="titles">
          <h1>Relat√≥rios</h1>
          <p>Par√≥quia Divino Esp√≠rito Santo ‚Äî Jati√∫ca ‚Ä¢ Arquidiocese de Macei√≥</p>
        </div>
      </div>
      <div class="stamp" title="Servi√ßo Pastoral">
        <span class="dot" aria-hidden="true"></span>
        <span>Servi√ßo √† comunidade</span>
      </div>
    </header>

    <section class="hero" role="region" aria-label="Filtros e a√ß√µes">
      <div class="text">
        <h2>Vis√£o estat√≠stica do ECC</h2>
        <p>Origem (ano de encontro), casais que trabalharam (dedup) e total de registros por ano.</p>
      </div>
      <div class="actions">
        <label for="anoSel" style="color:var(--muted); font-size:13px;">Ano de trabalho:</label>
        <select id="anoSel">
          {% for a in anos %}
            <option value="{{a}}">{{a}}</option>
          {% endfor %}
        </select>
        <a class="btn" href="{{ url_for('docs_index') }}" target="_blank">üñ®Ô∏è Documentos de impress√£o</a>
      </div>
    </section>

    <!-- DONUT em cima -->
    <div class="stack" aria-label="Gr√°ficos de Relat√≥rios">
      <div class="chart-card">
        <canvas id="distAnoEncontro"></canvas>
        <div id="msgDist" class="msg" style="display:none;"></div>
      </div>

      <!-- Barras: casais (dedup) -->
      <div class="chart-card">
        <canvas id="barTrabalhos"></canvas>
        <div id="msgBar" class="msg" style="display:none;"></div>
      </div>

      <!-- NOVO: Barras ‚Äî registros em 'encontreiros' por ano -->
      <div class="chart-card">
        <canvas id="barEncontreiros"></canvas>
        <div id="msgEnctr" class="msg" style="display:none;"></div>
      </div>
    </div>
  </div>

<script>
let chBar, chDist, chEnctr;
function destroyIf(c){ if(c) c.destroy(); }
function showMsg(id, text){ const el = document.getElementById(id); if(!el) return; el.textContent = text; el.style.display = 'grid'; }
function hideMsg(id){ const el = document.getElementById(id); if(!el) return; el.style.display = 'none'; }

async function safeFetchJson(url){
  const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
  if(!res.ok){
    const t = await res.text();
    throw new Error(`HTTP ${res.status} em ${url} ‚Üí ${t.slice(0,200)}`);
  }
  return res.json();
}

async function carregaTrabalhosPorAno(){
  try{
    hideMsg('msgBar');
    const data = await safeFetchJson("/api/trabalhos_por_ano");
    const labels = data.map(d => d.ano);
    const valores = data.map(d => d.qtd);
    destroyIf(chBar);
    chBar = new Chart(document.getElementById("barTrabalhos"), {
      type: "bar",
      data: { labels, datasets: [{ label: "Casais que trabalharam por ano (dedup)", data: valores }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }catch(err){
    console.error(err);
    showMsg('msgBar', "Erro ao carregar 'casais que trabalharam por ano'. Verifique /api/trabalhos_por_ano.");
  }
}

async function carregaEncontreirosPorAno(){
  try{
    hideMsg('msgEnctr');
    const data = await safeFetchJson("/api/encontreiros_por_ano");
    const labels = data.map(d => d.ano);
    const valores = data.map(d => d.qtd);
    destroyIf(chEnctr);
    chEnctr = new Chart(document.getElementById("barEncontreiros"), {
      type: "bar",
      data: { labels, datasets: [{ label: "Registros de encontreiros por ano", data: valores }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }catch(err){
    console.error(err);
    showMsg('msgEnctr', "Erro ao carregar 'encontreiros por ano'. Verifique /api/encontreiros_por_ano.");
  }
}

async function carregaDistribuicaoAnoEncontro(ano){
  try{
    hideMsg('msgDist');
    if(!ano){ throw new Error("Ano inv√°lido"); }
    const data = await safeFetchJson(`/api/ano_origem_dos_trabalhadores?ano=${encodeURIComponent(ano)}`);
    if(!data.dist){ throw new Error("Resposta inesperada da API"); }
    const labels = data.dist.map(d => d.ano_encontro);
    const valores = data.dist.map(d => d.qtd);
    destroyIf(chDist);
    chDist = new Chart(document.getElementById("distAnoEncontro"), {
      type: "doughnut",
      data: { labels, datasets: [{ label: `Ano de encontro de quem trabalhou em ${ano}`, data: valores }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }catch(err){
    console.error(err);
    showMsg('msgDist', "Erro ao carregar 'origem (ano de encontro)'. Verifique /api/ano_origem_dos_trabalhadores?ano=AAAA.");
  }
}

document.getElementById("anoSel").addEventListener("change", e => carregaDistribuicaoAnoEncontro(e.target.value));
window.addEventListener("DOMContentLoaded", async () => {
  if(!window.Chart){
    showMsg('msgDist', "Chart.js n√£o carregou. Verifique a conex√£o com a CDN.");
    showMsg('msgBar', "Chart.js n√£o carregou. Verifique a conex√£o com a CDN.");
    showMsg('msgEnctr', "Chart.js n√£o carregou. Verifique a conex√£o com a CDN.");
    return;
  }
  const anoIni = document.getElementById("anoSel")?.value;
  await carregaDistribuicaoAnoEncontro(anoIni);   // donut
  await carregaTrabalhosPorAno();                 // barras (dedup)
  await carregaEncontreirosPorAno();              // barras (registros)
});
</script>
</body>
</html>
